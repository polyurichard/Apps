<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartQuiz Cloud Architecture Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        aws: {
                            orange: '#FF9900',
                            blue: '#232F3E',
                            lightblue: '#1A73E8',
                        },
                        quiz: {
                            primary: '#5D5CDE'
                        }
                    },
                    boxShadow: {
                        'aws': '0 4px 6px -1px rgba(255, 153, 0, 0.1), 0 2px 4px -1px rgba(255, 153, 0, 0.06)',
                        'aws-lg': '0 10px 15px -3px rgba(255, 153, 0, 0.1), 0 4px 6px -2px rgba(255, 153, 0, 0.05)',
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        /* Container Styles */
        .architecture-container {
            height: 100%;
            min-height: 300px;
        }
        
        /* Component Card Styles */
        .component-card {
            transition: all 0.3s ease;
        }
        .component-card:hover:not(.disabled) {
            transform: translateY(-3px);
        }
        .component-card.selected {
            border-color: #FF9900;
            background-color: rgba(255, 153, 0, 0.1);
        }
        .component-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }
        
        /* Modal Styles */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .modal:not(.show) {
            opacity: 0;
            pointer-events: none;
        }
        .modal:not(.show) .modal-content {
            transform: translateY(-20px);
        }
        
        /* Instruction Styles */
        .instruction-step {
            position: relative;
            padding-left: 2.5rem;
            margin-bottom: 0.75rem;
            counter-increment: step-counter;
        }
        .instruction-step::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 1.75rem;
            height: 1.75rem;
            background-color: #FF9900;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .instruction-section {
            border-left: 3px solid #FF9900;
            padding-left: 1rem;
            margin-bottom: 1.5rem;
        }
        .instruction-important {
            background-color: rgba(255, 153, 0, 0.1);
            border-left: 3px solid #FF9900;
            padding: 0.75rem;
            border-radius: 0 0.25rem 0.25rem 0;
            margin: 1rem 0;
        }
        
        /* Responsive modal styles */
        @media (max-height: 700px) {
            #modal-content {
                font-size: 0.9rem;
            }
            .instruction-step {
                padding-left: 2rem;
                margin-bottom: 0.5rem;
            }
            .instruction-step::before {
                width: 1.5rem;
                height: 1.5rem;
            }
            .instruction-section {
                padding-left: 0.75rem;
                margin-bottom: 1rem;
            }
            .instruction-important {
                padding: 0.5rem;
                margin: 0.75rem 0;
            }
        }
        .task-highlight {
            display: inline-block;
            background-color: #E3F2FD;
            color: #1565C0;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }
        .dark .task-highlight {
            background-color: rgba(21, 101, 192, 0.2);
            color: #90CAF9;
        }
        .setting-highlight {
            font-family: monospace;
            background-color: #FFFDE7;
            color: #F57F17;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            font-weight: bold;
            white-space: nowrap;
            border: 1px solid rgba(245, 127, 23, 0.3);
        }
        .dark .setting-highlight {
            background-color: rgba(245, 127, 23, 0.15);
            color: #FFCC80;
            border-color: rgba(255, 204, 128, 0.3);
        }
        
        /* AWS Component Icons */
        .aws-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        .lambda-icon-bg {
            background-color: #FF9900;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .lambda-icon-symbol {
            color: white;
            font-family: serif;
            font-size: 18px;
            font-weight: bold;
            margin-top: -3px;
            transform: scaleX(0.9);
        }
        .dark .lambda-icon-bg {
            box-shadow: 0 0 8px rgba(255, 153, 0, 0.6);
        }
        
        /* Architecture layer styles */
        .arch-layer {
            fill-opacity: 0.1;
            stroke-width: 1;
        }
        .dark .arch-layer {
            fill-opacity: 0.2;
        }
        .arch-layer-label {
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            pointer-events: none;
        }
        .dark .arch-layer-label {
            fill: #FFF;
        }
        
        /* Panel styles */
        .panel-header {
            @apply text-sm font-bold mb-2 text-aws-blue dark:text-aws-orange;
        }
        .panel {
            @apply bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4;
        }
        .btn-primary {
            @apply bg-quiz-primary hover:bg-indigo-600 text-white py-2 px-4 rounded;
        }
        .btn-disabled {
            @apply opacity-50 cursor-not-allowed;
        }
        
        /* SVG component styling */
        .component-icon svg {
            width: 20px;
            height: 20px;
        }
        
        /* Responsive layout */
        .main-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
        }
        
        /* Styles for scrollable containers */
        .component-list-container, #configuration-form {
            overflow-y: auto;
            scrollbar-width: thin;
        }
        .component-list-container::-webkit-scrollbar, #configuration-form::-webkit-scrollbar {
            width: 6px;
        }
        .component-list-container::-webkit-scrollbar-track, #configuration-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .component-list-container::-webkit-scrollbar-thumb, #configuration-form::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        .component-list-container::-webkit-scrollbar-thumb:hover, #configuration-form::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        .content-container {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        .left-panel-container {
            flex: 0 0 45%;
            overflow-y: auto;
            padding-right: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .left-panel-scroll {
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .right-panel {
            flex: 0 0 55%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        
        .panel-scrollable {
            overflow-y: auto;
            flex: 1;
        }
        
        /* Responsive font size adjustments based on height */
        @media (max-height: 800px) {
            .left-panel-container {
                font-size: 0.85rem;
            }
            .component-card .name {
                font-size: 0.75rem;
            }
            .component-card .description {
                font-size: 0.65rem;
            }
            .panel-header {
                font-size: 0.75rem;
                margin-bottom: 0.4rem;
            }
        }
        
        @media (max-height: 700px) {
            .left-panel-container {
                font-size: 0.8rem;
            }
            .component-card {
                padding: 0.25rem 0.5rem;
                margin-bottom: 0.4rem;
            }
            .component-card .icon {
                transform: scale(0.8);
            }
            .panel {
                padding: 0.4rem;
            }
            #key-requirements {
                gap: 1px;
            }
            #key-requirements > div {
                font-size: 0.75rem;
            }
        }
        
        @media (max-height: 600px) {
            .left-panel-container {
                font-size: 0.7rem;
            }
            .stage-info-description {
                font-size: 0.7rem;
            }
            .component-card .name {
                font-size: 0.7rem;
            }
            .component-card .description {
                font-size: 0.6rem;
            }
            .panel-header {
                font-size: 0.7rem;
                margin-bottom: 0.2rem;
            }
            #stage-info-description {
                font-size: 0.75rem;
            }
        }
        
        .metrics-container {
            flex-shrink: 0;
        }
        
        /* Component dropdown styles */
        .component-dropdown {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .component-dropdown select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.25rem;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            font-size: 0.875rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        .dark .component-dropdown select {
            background-color: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23e5e7eb'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        }
        
        /* Component sizing */
        @media (max-height: 700px) {
            .panel {
                padding: 0.6rem;
            }
            .component-card {
                padding: 0.4rem;
            }
        }
        
        /* Game Completion Modal */
        .game-completion-modal .completion-badge {
            background: linear-gradient(135deg, #4CAF50, #2196F3);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin: 0 auto 20px;
        }
        
        .final-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background: rgba(93, 92, 222, 0.08);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #5D5CDE;
            margin: 5px 0;
        }
        
        .dark .stat-value {
            color: #8C8BFF;
        }
        
        .dark .stat-card {
            background: rgba(93, 92, 222, 0.12);
        }
        
        .completion-checkmark {
            color: #4CAF50;
            display: inline-block;
            margin-right: 5px;
        }
        
        /* Make game completion modal more responsive */
        @media (max-height: 800px) {
            .game-completion-modal .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
            .game-completion-modal .completion-badge {
                width: 60px;
                height: 60px;
                margin-bottom: 10px;
            }
            .game-completion-modal h2 {
                font-size: 1.5rem;
            }
            .game-completion-modal p {
                font-size: 0.9rem;
            }
            .final-stats-grid {
                gap: 10px;
            }
            .stat-card {
                padding: 8px;
            }
            .stat-value {
                font-size: 1.2rem;
                margin: 3px 0;
            }
        }
        
        @media (max-height: 600px) {
            .game-completion-modal .p-8 {
                padding: 1rem;
            }
            .game-completion-modal .mb-8 {
                margin-bottom: 0.75rem;
            }
            .game-completion-modal .completion-badge {
                width: 40px;
                height: 40px;
            }
            .game-completion-modal .completion-badge svg {
                width: 24px;
                height: 24px;
            }
            .game-completion-modal h2 {
                font-size: 1.25rem;
                margin-bottom: 0.5rem;
            }
            .game-completion-modal p {
                font-size: 0.8rem;
            }
            .game-completion-modal h3 {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }
            .game-completion-modal h4 {
                font-size: 0.9rem;
            }
            .game-completion-modal .p-6 {
                padding: 0.75rem;
            }
            .stat-card {
                padding: 6px;
            }
            .stat-value {
                font-size: 1rem;
                margin: 2px 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-white min-h-screen">
    <!-- Project phase indicator removed from here -->
    
    <div class="container mx-auto px-4 py-2 main-container">
        <!-- Header -->
        <header class="flex justify-between items-center mb-2">
            <h1 class="text-xl lg:text-2xl font-bold text-aws-blue dark:text-aws-orange">SmartQuiz Cloud Architecture Simulator</h1>
            <div class="flex items-center">
                <div class="flex items-center">
                    <div class="mr-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <span class="font-semibold">Project Phase: </span>
                        <span id="project-day-counter" class="font-bold"> 1</span>
                    </div>
                    <div>
                        <span class="font-semibold">Stage: </span>
                        <span id="current-stage" class="bg-aws-orange text-white px-2 py-1 rounded-full text-sm">1</span>
                        <span id="stage-name" class="italic ml-2 text-aws-blue dark:text-aws-orange">Set Up Database</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area - 2 Column Layout -->
        <div class="content-container">
            <!-- Left Column: Controls and Information -->
            <div class="left-panel-container w-1/2">
                <div class="left-panel-scroll">
                    <!-- Instructions button without the panel -->
                    <div class="flex justify-end mb-3">
                        <button id="instructions-btn" class="bg-aws-orange hover:bg-amber-600 dark:bg-aws-orange text-white px-4 py-1.5 rounded text-sm flex items-center shadow hover:shadow-md transition-all duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                            View Detailed Instructions
                        </button>
                    </div>
                    
                    <!-- Stage Information Box with Key Requirements -->
                    <div class="panel mb-4">
                        <h2 class="panel-header flex items-center text-aws-blue dark:text-aws-orange text-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-aws-orange" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            Project Phase <span id="info-phase-number" class="font-bold mx-1">1</span> - Stage <span id="info-stage-number" class="font-bold mx-1">1</span>: <span id="info-stage-name" class="font-medium">Set Up Database</span>
                        </h2>
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mt-2">
                            <div class="flex mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-aws-lightblue mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p id="stage-info-description" class="text-sm leading-relaxed font-medium text-blue-800 dark:text-blue-200">Configure a DynamoDB table for storing quiz data with appropriate capacity and indexes.</p>
                            </div>
                            <div class="mt-3 border-t border-blue-200 dark:border-blue-800 pt-3">
                                <h3 class="text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2">Key Requirements:</h3>
                                <div id="key-requirements" class="flex flex-col gap-1.5 pl-1">
                                    <!-- Key requirements will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Components and Configuration Row -->
                    <div class="flex flex-row gap-3">
                        <!-- Available Components Panel -->
                        <div class="panel w-1/2 flex-shrink-0">
                            <h2 class="panel-header flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-aws-orange" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                </svg>
                                Available Components
                            </h2>
                            
                            <!-- Component Layer Dropdown -->
                            <div class="component-dropdown mt-2">
                                <select id="component-layer-select" class="focus:ring-aws-orange focus:border-aws-orange">
                                    <!-- Options will be populated here -->
                                </select>
                            </div>
                            
                            <!-- Component List -->
                            <div id="component-list" class="flex flex-col gap-1.5 max-h-[300px] overflow-y-auto pr-1 component-list-container">
                                <!-- Components will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Configuration Panel -->
                        <div class="panel w-1/2 bg-gradient-to-b from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 shadow-lg border border-gray-200 dark:border-gray-700 rounded-lg">
                            <h2 class="panel-header text-aws-blue dark:text-aws-orange border-b border-gray-200 dark:border-gray-700 pb-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-aws-orange" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Configuration
                            </h2>
                            <div id="configuration-form" class="space-y-2 p-3 bg-gray-50 dark:bg-gray-800 rounded m-2 max-h-[300px] overflow-y-auto text-sm">
                                <p class="text-center text-gray-500 dark:text-gray-400 py-4">Select a component to configure</p>
                            </div>
                            <div class="mt-3 flex justify-center pb-2">
                                <button id="apply-btn" class="bg-aws-orange hover:bg-amber-600 text-white py-1.5 px-4 rounded btn-disabled transition-all duration-200 transform hover:scale-105 shadow-md disabled:shadow-none disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metrics Panel -->
                    <div id="metrics-panel" class="panel metrics-container mt-3 hidden">
                        <h2 class="panel-header flex justify-between items-center">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-aws-orange" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                                <span>Metrics</span>
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400">Performance Indicators</span>
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2">
                            <!-- User Metrics -->
                            <div class="md:col-span-3 mb-1 border-b border-gray-200 dark:border-gray-700 pb-1">
                                <h3 class="text-xs font-medium text-aws-blue dark:text-aws-orange flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1 text-aws-orange" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                    User Metrics
                                </h3>
                            </div>
                            
                            <div>
                                <div class="flex justify-between">
                                    <span class="text-xs">Active Users:</span>
                                    <span id="metric-users" class="text-xs font-semibold">0</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                    <div id="bar-users" class="bg-indigo-500 h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between">
                                    <span class="text-xs">Satisfaction:</span>
                                    <span id="metric-satisfaction" class="text-xs font-semibold">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                    <div id="bar-satisfaction" class="bg-pink-500 h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between">
                                    <span class="text-xs">Scalability:</span>
                                    <span id="metric-scalability" class="text-xs font-semibold">Low</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                    <div id="bar-scalability" class="bg-teal-500 h-1.5 rounded-full" style="width: 10%"></div>
                                </div>
                            </div>
                            
                            <!-- Performance Metrics -->
                            <div class="md:col-span-3 mt-2 mb-1 border-b border-gray-200 dark:border-gray-700 pb-1">
                                <h3 class="text-xs font-medium text-aws-blue dark:text-aws-orange flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1 text-aws-orange" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                    </svg>
                                    Performance Metrics
                                </h3>
                            </div>
                            
                            <div>
                                <div class="flex justify-between">
                                    <span class="text-xs">Reliability:</span>
                                    <span id="metric-reliability" class="text-xs font-semibold">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                    <div id="bar-reliability" class="bg-green-500 h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between">
                                    <span class="text-xs">Availability:</span>
                                    <span id="metric-availability" class="text-xs font-semibold">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                    <div id="bar-availability" class="bg-blue-500 h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between">
                                    <span class="text-xs">Latency:</span>
                                    <span id="metric-latency" class="text-xs font-semibold">800ms</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                    <div id="bar-latency" class="bg-yellow-500 h-1.5 rounded-full" style="width: 80%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between">
                                    <span class="text-xs">Transactions/s:</span>
                                    <span id="metric-performance" class="text-xs font-semibold">0</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                    <div id="bar-performance" class="bg-purple-600 h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between">
                                    <span class="text-xs">Security:</span>
                                    <span id="metric-security" class="text-xs font-semibold">Low</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                    <div id="bar-security" class="bg-red-500 h-1.5 rounded-full" style="width: 10%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between">
                                    <span class="text-xs">Cost:</span>
                                    <span id="metric-cost" class="text-xs font-semibold">$10/day</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                    <div id="bar-cost" class="bg-orange-500 h-1.5 rounded-full" style="width: 10%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="feedback-container" class="panel mt-3 rounded">
                        <p id="feedback-message" class="text-sm">Select components and configure them to build your SmartQuiz platform.</p>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Architecture Diagram -->
            <div class="right-panel w-1/2 panel">
                <h2 class="panel-header">Architecture Diagram</h2>
                <div id="architecture-diagram" class="w-full h-full relative">
                    <!-- SVG diagram will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Task Completion Modal -->
    <div id="completion-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <div class="bg-green-100 dark:bg-green-900 p-2 rounded-full mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 dark:text-green-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Task Completed!</h3>
                    </div>
                    <div>
                        <span class="text-sm text-gray-500 dark:text-gray-400">Project Phase:</span>
                        <span class="text-lg font-bold ml-1 text-aws-orange dark:text-aws-orange" id="modal-project-day">1</span>
                    </div>
                </div>
                
                <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                    <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-2" id="completion-task-name">Task Name</h4>
                    <p id="completion-description" class="text-blue-700 dark:text-blue-300 text-sm">Task description will appear here.</p>
                </div>
                
                <div class="border-t border-b border-gray-200 dark:border-gray-700 py-4 my-4">
                    <h4 class="font-semibold mb-3">Impact on Metrics:</h4>
                    <div id="metric-changes" class="grid grid-cols-2 gap-4">
                        <!-- Metrics changes will be populated here -->
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="font-semibold mb-2">Project Timeline:</h4>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                        <p id="timeline-description" class="text-sm text-gray-700 dark:text-gray-300">
                            Project timeline event will appear here.
                        </p>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="continue-btn" class="bg-aws-orange dark:bg-aws-orange text-white px-4 py-2 rounded shadow hover:bg-opacity-90 transition-all flex items-center">
                        <span>Continue</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Instructions Modal -->
    <div id="instructions-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div>
                        <span class="bg-aws-orange text-white px-2 py-1 rounded-full text-sm">Stage <span id="modal-stage-number">1</span></span>
                        <h3 id="modal-title" class="text-2xl font-bold text-aws-blue dark:text-aws-orange mt-2">Set Up Database</h3>
                    </div>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div id="modal-content" class="prose dark:prose-invert max-w-none">
                    <!-- Content will be dynamically inserted -->
                </div>
                
                <div class="mt-8 flex justify-end">
                    <button id="start-stage" class="bg-aws-orange hover:bg-amber-600 text-white py-2 px-4 rounded transition-all duration-200 transform hover:scale-105 flex items-center px-6 py-3 font-medium shadow">
                        <span>Start Stage</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Project Phase Completion Modal -->
    <div id="phase-completion-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <div class="bg-aws-orange text-white p-3 rounded-full mr-4 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <div>
                            <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs font-medium px-2.5 py-0.5 rounded">PROJECT MILESTONE</span>
                            <h3 class="text-2xl font-bold text-aws-blue dark:text-aws-orange mt-1">Phase 1 Complete!</h3>
                        </div>
                    </div>
                </div>
                
                <div class="my-6 p-5 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg border border-blue-100 dark:border-blue-800">
                    <h4 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-3">Congratulations!</h4>
                    <p class="text-blue-700 dark:text-blue-300">
                        You have successfully completed all five stages of Phase 1 and built a fully functional serverless architecture for the SmartQuiz platform.
                    </p>
                    <div class="mt-4 flex flex-wrap gap-3">
                        <div class="px-3 py-1.5 bg-white dark:bg-gray-800 rounded-full text-sm font-medium shadow-sm">
                            <span class="text-aws-orange">✓</span> DynamoDB
                        </div>
                        <div class="px-3 py-1.5 bg-white dark:bg-gray-800 rounded-full text-sm font-medium shadow-sm">
                            <span class="text-aws-orange">✓</span> Lambda
                        </div>
                        <div class="px-3 py-1.5 bg-white dark:bg-gray-800 rounded-full text-sm font-medium shadow-sm">
                            <span class="text-aws-orange">✓</span> API Gateway
                        </div>
                        <div class="px-3 py-1.5 bg-white dark:bg-gray-800 rounded-full text-sm font-medium shadow-sm">
                            <span class="text-aws-orange">✓</span> S3
                        </div>
                        <div class="px-3 py-1.5 bg-white dark:bg-gray-800 rounded-full text-sm font-medium shadow-sm">
                            <span class="text-aws-orange">✓</span> Cognito
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            Key Achievements
                        </h4>
                        <ul class="space-y-2 text-sm">
                            <li class="flex items-start">
                                <svg class="h-4 w-4 text-green-500 mt-0.5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Scalable NoSQL database setup</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-4 w-4 text-green-500 mt-0.5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Serverless compute with auto-scaling</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-4 w-4 text-green-500 mt-0.5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Secure API with caching and rate limiting</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-4 w-4 text-green-500 mt-0.5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Static web asset storage with versioning</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-4 w-4 text-green-500 mt-0.5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>User authentication with MFA support</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                            </svg>
                            Platform Metrics
                        </h4>
                        <div class="space-y-3 text-sm">
                            <div>
                                <div class="flex justify-between items-center">
                                    <span>Reliability:</span>
                                    <span id="summary-reliability" class="font-medium text-green-600 dark:text-green-400">95%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-1">
                                    <div id="summary-bar-reliability" class="bg-green-500 h-1.5 rounded-full" style="width: 95%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center">
                                    <span>Availability:</span>
                                    <span id="summary-availability" class="font-medium text-blue-600 dark:text-blue-400">97%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-1">
                                    <div id="summary-bar-availability" class="bg-blue-500 h-1.5 rounded-full" style="width: 97%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center">
                                    <span>Latency:</span>
                                    <span id="summary-latency" class="font-medium text-yellow-600 dark:text-yellow-400">100ms</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-1">
                                    <div id="summary-bar-latency" class="bg-yellow-500 h-1.5 rounded-full" style="width: 87%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center">
                                    <span>Security:</span>
                                    <span id="summary-security" class="font-medium text-purple-600 dark:text-purple-400">High</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-1">
                                    <div id="summary-bar-security" class="bg-purple-500 h-1.5 rounded-full" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 bg-gray-50 dark:bg-gray-900 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h4 class="font-semibold mb-2">Next Steps</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        Your SmartQuiz platform now has a solid foundation with all the essential cloud components. Here's what to look forward to in Phase 2:
                    </p>
                    <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1 pl-5 list-disc">
                        <li>Setting up global content delivery using CloudFront</li>
                        <li>Implementing advanced monitoring with CloudWatch</li>
                        <li>Adding asynchronous message processing with SQS</li>
                        <li>Building notification systems with SNS</li>
                        <li>Enhancing database performance with Redis caching</li>
                    </ul>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="phase-complete-btn" class="bg-aws-orange dark:bg-aws-orange text-white px-6 py-2 rounded shadow hover:bg-opacity-90 transition-all flex items-center font-medium">
                        <span>Continue</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Game Completion Modal -->
    <div id="game-completion-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 game-completion-modal">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 overflow-hidden">
            <div class="p-8">
                <div class="text-center mb-8">
                    <div class="completion-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Congratulations!</h2>
                    <p class="text-lg text-gray-600 dark:text-gray-300">You've successfully built the complete SmartQuiz cloud architecture</p>
                    <div class="flex justify-center items-center mt-4 space-x-2">
                        <div class="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 rounded-full text-sm font-semibold">
                            Phase 1 Complete
                        </div>
                        <div class="px-3 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-300 rounded-full text-sm font-semibold">
                            Phase 2 Complete
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 p-6 rounded-lg mb-8">
                    <h3 class="text-xl font-semibold text-indigo-800 dark:text-indigo-200 mb-4">Architecture Highlights</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <h4 class="font-semibold text-indigo-700 dark:text-indigo-300 mb-2">Core Components</h4>
                            <ul class="space-y-1">
                                <li class="flex items-center">
                                    <span class="completion-checkmark">✓</span> Serverless compute with Lambda
                                </li>
                                <li class="flex items-center">
                                    <span class="completion-checkmark">✓</span> NoSQL database with DynamoDB
                                </li>
                                <li class="flex items-center">
                                    <span class="completion-checkmark">✓</span> Secure APIs with API Gateway
                                </li>
                                <li class="flex items-center">
                                    <span class="completion-checkmark">✓</span> Authentication with Cognito
                                </li>
                                <li class="flex items-center">
                                    <span class="completion-checkmark">✓</span> Static content hosting with S3
                                </li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold text-indigo-700 dark:text-indigo-300 mb-2">Advanced Components</h4>
                            <ul class="space-y-1">
                                <li class="flex items-center">
                                    <span class="completion-checkmark">✓</span> Global content delivery with CloudFront
                                </li>
                                <li class="flex items-center">
                                    <span class="completion-checkmark">✓</span> Real-time monitoring with CloudWatch
                                </li>
                                <li class="flex items-center">
                                    <span class="completion-checkmark">✓</span> Message queuing with SQS
                                </li>
                                <li class="flex items-center">
                                    <span class="completion-checkmark">✓</span> Notifications with SNS
                                </li>
                                <li class="flex items-center">
                                    <span class="completion-checkmark">✓</span> High-performance caching with Redis
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <h3 class="text-xl font-semibold mb-4 text-center">Final Platform Metrics</h3>
                <div class="final-stats-grid mb-8">
                    <div class="stat-card">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Reliability</span>
                        <span id="final-reliability" class="stat-value">99.95%</span>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                            <div class="bg-green-500 h-1.5 rounded-full" style="width: 99.95%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Availability</span>
                        <span id="final-availability" class="stat-value">99.95%</span>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                            <div class="bg-blue-500 h-1.5 rounded-full" style="width: 99.95%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Active Users</span>
                        <span id="final-users" class="stat-value">18,450</span>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                            <div class="bg-indigo-500 h-1.5 rounded-full" style="width: 95%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="text-sm text-gray-600 dark:text-gray-400">User Satisfaction</span>
                        <span id="final-satisfaction" class="stat-value">98%</span>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                            <div class="bg-pink-500 h-1.5 rounded-full" style="width: 98%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Latency</span>
                        <span id="final-latency" class="stat-value">25ms</span>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                            <div class="bg-yellow-500 h-1.5 rounded-full" style="width: 97%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Security</span>
                        <span id="final-security" class="stat-value">Excellent</span>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                            <div class="bg-red-500 h-1.5 rounded-full" style="width: 95%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <p class="text-gray-600 dark:text-gray-400 mb-6">Your SmartQuiz architecture is now ready to serve millions of students worldwide with high performance, scalability, and security.</p>
                    
                    <button id="game-complete-btn" class="bg-quiz-primary hover:bg-indigo-600 text-white px-8 py-3 rounded-lg text-lg font-medium shadow-lg hover:shadow-xl transition-all duration-300">
                        Finish
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management - DEFINED HERE BEFORE ANY FUNCTIONS THAT USE IT
        const state = {
            currentStage: 1,
            selectedComponent: null,
            appliedComponents: [],
            completedComponents: [], // Track which components have been successfully completed
            architecture: [],
            projectDay: 1,
            stagesCompleted: 0,
            previousMetrics: {}, // Store previous metrics for comparison
            allComponentsComplete: false, // Flag to track when all components are complete
            showedPhase1Completion: false // Flag to track if we've shown the phase 1 completion modal
        };

        // Initialize dark mode
        function initDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        }

        // Component data definition for SmartQuiz
        const componentsData = {
            "lambda": {
                name: "AWS Lambda",
                description: "Serverless compute service",
                layer: "compute",
                icon: `<div class="aws-icon"><div class="lambda-icon-bg"><span class="lambda-icon-symbol">λ</span></div></div>`,
                configOptions: [
                    { name: "runtime", label: "Runtime", type: "select", options: ["Node.js 14.x", "Node.js 16.x", "Python 3.8", "Python 3.9", "Java 11"] },
                    { name: "memory", label: "Memory (MB)", type: "select", options: ["128", "256", "512", "1024", "2048"] },
                    { name: "timeout", label: "Timeout (seconds)", type: "select", options: ["3", "10", "30", "60", "900"] },
                    { name: "concurrency", label: "Concurrency Limits", type: "select", options: ["Unreserved", "500 Reserved", "1000 Reserved", "2000 Reserved", "Provisioned"] },
                    { name: "region", label: "Region", type: "select", options: ["us-east-1", "us-west-2", "eu-west-1", "ap-northeast-1", "ap-southeast-1"] }
                ]
            },
            "api-gateway": {
                name: "API Gateway",
                description: "Create, publish, maintain APIs",
                layer: "api",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-8 h-8 mx-auto"><path fill="currentColor" d="M22 12A10 10 0 0 0 12 2a10 10 0 0 0 0 20a10 10 0 0 0 10-10M8 8h8v1h-8zm2 2h4v1h-4zm-2 2h8v1h-8zm2 2h4v1h-4z"/></svg>`,
                configOptions: [
                    { name: "endpoint-type", label: "Endpoint Type", type: "select", options: ["Regional", "Edge Optimized", "Private"] },
                    { name: "auth-type", label: "Authorization", type: "select", options: ["None", "IAM", "Cognito", "Lambda Authorizer", "API Key"] },
                    { name: "cache-enabled", label: "Caching", type: "select", options: ["Disabled", "0.5GB/30s TTL", "1.6GB/45s TTL", "6.1GB/60s TTL", "13.5GB/300s TTL"] },
                    { name: "rate-limit", label: "Rate Limit (req/sec)", type: "select", options: ["500", "1000", "2000", "5000", "10000"] }
                ]
            },
            "dynamodb": {
                name: "DynamoDB",
                description: "NoSQL database service",
                layer: "database",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-8 h-8 mx-auto"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2M5 5h14v3H5zm0 5h3v9H5zm5 9v-9h9v9z"/></svg>`,
                configOptions: [
                    { name: "read-capacity", label: "Read Capacity", type: "select", options: ["1", "5", "10", "20", "Auto"] },
                    { name: "write-capacity", label: "Write Capacity", type: "select", options: ["1", "5", "10", "20", "Auto"] },
                    { name: "partition-key", label: "Partition Key", type: "text", placeholder: "e.g., userId" },
                    { name: "secondary-indexes", label: "Secondary Indexes", type: "select", options: ["None", "1 GSI", "2 GSI", "GSI + LSI"] },
                    { name: "backup", label: "Backup Options", type: "select", options: ["None", "On-demand", "Point-in-time", "Continuous"] },
                    { name: "encryption", label: "Encryption at Rest", type: "select", options: ["Default", "KMS Managed", "Customer Managed"] }
                ]
            },
            "redis": {
                name: "Redis",
                description: "In-memory caching service",
                layer: "database",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-8 h-8 mx-auto"><path fill="currentColor" d="M10.5 2.661l.54.997-1.797.644 2.409.218.748 1.246.467-1.121 2.077-.208-1.61-.905.426-1.017-1.578.519zm4.344 1.119l-.08 1.483 1.088.387-.813.293.951 1.246.139-1.221 1.47-.61-1.35-.19-.118-1.393-.905.761zm-7.518.382l-1.261.748 1.616.529.139.608-1.069.728 1.338.12.258.669.18-.848 1.307-.339-1.069-.519zm1.159 3.306L5.298 8.823l5.38 2.109 5.518-2.223-5.419-2.139a.52.52 0 00-.391 0zm5.757 2.75l-5.518 2.139-.03.828 5.548-1.888V10.28v-.061zm-11.732.06v.18l5.35 2.128v-.848l-5.35-1.888v.428zm-.01 1.758v.827L8.285 15l-.02-.867-4.765-1.817zm11.732.04l-5.488 1.888-.03.848 5.518-2.139v-.598zm.01 1.847l-5.499 2.189v.867l5.499-2.219v-.837zm-11.742.02v.837l5.37 2.001v-.838l-5.37-2z"/></svg>`,
                configOptions: [
                    { name: "instance-type", label: "Instance Type", type: "select", options: ["cache.t3.micro", "cache.t3.small", "cache.m5.large", "cache.r5.large", "cache.r5.xlarge"] },
                    { name: "cluster-mode", label: "Cluster Mode", type: "select", options: ["Disabled", "Enabled"] },
                    { name: "nodes", label: "Number of Nodes", type: "select", options: ["1", "2", "3", "5", "10"] },
                    { name: "encryption", label: "Encryption", type: "select", options: ["None", "In-Transit", "At-Rest", "Both"] },
                    { name: "auto-failover", label: "Auto Failover", type: "select", options: ["Enabled", "Disabled"] }
                ]
            },
            "s3": {
                name: "S3",
                description: "Object storage service",
                layer: "storage", // Changed back to "storage" from "compute"
                icon: `<div class="flex justify-center items-center mx-auto text-aws-orange">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M13 5v6h6V5h-6zm0 8v6h6v-6h-6zm-8 0v6h6v-6H5zm0-8v6h6V5H5z"/>
                    </svg>
                </div>`,
                configOptions: [
                    { name: "access", label: "Access", type: "select", options: ["Private", "Public Read", "Public Read/Write"] },
                    { name: "versioning", label: "Versioning", type: "select", options: ["Enabled", "Disabled"] },
                    { name: "lifecycle", label: "Lifecycle Policies", type: "select", options: ["None", "30-day IA + Glacier", "60-day IA + 1yr Glacier", "60-day IA + Delete"] }
                ]
            },
            "cloudfront": {
                name: "CloudFront",
                description: "Content delivery network",
                layer: "edge",
                icon: `<div class="flex justify-center items-center mx-auto text-aws-orange">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M12 2C6.478 2 2 6.478 2 12s4.478 10 10 10 10-4.478 10-10S17.522 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zm-1-13.5v3a.5.5 0 0 0 1 0v-3a.5.5 0 0 0-1 0zm2.5 7.5a2.5 2.5 0 0 1-2.5 2.5 2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 2.5 2.5zm-1 0a1.5 1.5 0 0 0-1.5-1.5 1.5 1.5 0 0 0 0 3 1.5 1.5 0 0 0 1.5-1.5zm5.5-5h-3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1zm-8.5.5a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 1 .5.5z"/>
                    </svg>
                </div>`,
                configOptions: [
                    { name: "price-class", label: "Price Class", type: "select", options: ["All Edge Locations", "North America & Europe", "North America Only"] },
                    { name: "ttl", label: "Default TTL", type: "select", options: ["0", "86400", "604800", "2592000"] },
                    { name: "origin", label: "Origin", type: "select", options: ["S3 Website", "Custom Origin", "Multiple Origins"] },
                    { name: "security", label: "Security", type: "select", options: ["None", "HTTPS Only", "HTTPS + WAF", "HTTPS + WAF + Field-Level Encryption"] }
                ]
            },
            "cloudwatch": {
                name: "CloudWatch",
                description: "Monitoring and observability",
                layer: "monitoring",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-8 h-8 mx-auto"><path fill="currentColor" d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8zm3.5-9c.8 0 1.5-.7 1.5-1.5S16.3 8 15.5 8 14 8.7 14 9.5s.7 1.5 1.5 1.5zm-7 0c.8 0 1.5-.7 1.5-1.5S9.3 8 8.5 8 7 8.7 7 9.5 7.7 11 8.5 11zm3.5 6.5c2.1 0 4-1.5 4.4-3.5H7.6c.5 2 2.3 3.5 4.4 3.5z"/></svg>`,
                configOptions: [
                    { name: "metrics", label: "Metrics Collection", type: "select", options: ["Basic", "Detailed", "Custom"] },
                    { name: "alarm-threshold", label: "Error Rate Alarm", type: "select", options: ["1%", "2%", "5%", "10%"] },
                    { name: "log-retention", label: "Log Retention", type: "select", options: ["1 day", "1 week", "1 month", "6 months", "1 year"] },
                    { name: "dashboard", label: "Dashboard", type: "select", options: ["None", "Basic", "Comprehensive"] }
                ]
            },
            "sqs": {
                name: "SQS",
                description: "Message queuing service",
                layer: "messaging",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-8 h-8 mx-auto"><path fill="currentColor" d="M3 4v16h18V4H3zm16 2v12H5V6h14zm-3 2H8v2h8V8zm0 4H8v2h8v-2z"/></svg>`,
                configOptions: [
                    { name: "queue-type", label: "Queue Type", type: "select", options: ["Standard", "FIFO"] },
                    { name: "visibility-timeout", label: "Visibility Timeout", type: "select", options: ["30 seconds", "60 seconds", "5 minutes", "15 minutes", "30 minutes"] },
                    { name: "retention-period", label: "Message Retention", type: "select", options: ["1 hour", "1 day", "4 days", "14 days"] },
                    { name: "dlq", label: "Dead Letter Queue", type: "select", options: ["None", "After 3 Retries", "After 5 Retries", "After 10 Retries"] }
                ]
            },
            "sns": {
                name: "SNS",
                description: "Notification service",
                layer: "messaging",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-8 h-8 mx-auto"><path fill="currentColor" d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>`,
                configOptions: [
                    { name: "delivery-policy", label: "Delivery Policy", type: "select", options: ["No Retries", "3 Retries", "5 Retries", "10 Retries"] },
                    { name: "subscribers", label: "Subscribers", type: "select", options: ["Email Only", "SMS Only", "Lambda", "SQS", "Multiple Types"] },
                    { name: "message-filtering", label: "Message Filtering", type: "select", options: ["None", "Basic", "Advanced"] }
                ]
            },
            "cognito": {
                name: "Cognito",
                description: "User identity and access",
                layer: "security", // Changed back to "security" from "api"
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-8 h-8 mx-auto"><path fill="currentColor" d="M12 4a4 4 0 0 1 4 4a4 4 0 0 1-4 4a4 4 0 0 1-4-4a4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4m0-12A6 6 0 0 0 6 8a6 6 0 0 0 6 6a6 6 0 0 0 6-6a6 6 0 0 0-6-6"/></svg>`,
                configOptions: [
                    { name: "auth-flow", label: "Auth Flow", type: "select", options: ["USER_PASSWORD_AUTH", "CUSTOM_AUTH", "USER_SRP_AUTH"] },
                    { name: "mfa", label: "MFA", type: "select", options: ["OFF", "OPTIONAL", "REQUIRED"] },
                    { name: "token-expiry", label: "Token Expiry", type: "select", options: ["1 hour", "8 hours", "24 hours", "7 days"] }
                ]
            }
        };

        // Architecture layers configuration - Compute and Storage separated
        const architectureLayers = {
            "edge": {
                name: "Edge Services",
                color: "#4CAF50",  // Green
                x: 30,
                y: 60,
                width: 140,
                height: 80
            },
            "monitoring": {
                name: "Monitoring Layer",
                color: "#607D8B",  // Blue Grey
                x: 190,
                y: 60,
                width: 140,
                height: 80
            },
            "api": {
                name: "API Layer",
                color: "#2196F3",  // Blue
                x: 30,
                y: 180,
                width: 140,
                height: 80
            },
            "security": {
                name: "Security Layer",
                color: "#F44336",  // Red
                x: 190,
                y: 180,
                width: 140,
                height: 80
            },
            "compute": {
                name: "Compute Layer",
                color: "#FF9800",  // Orange
                x: 30,
                y: 300,
                width: 140,
                height: 80
            },
            "storage": {
                name: "Storage Layer",
                color: "#9C27B0",  // Purple
                x: 190,
                y: 300,
                width: 140,
                height: 80
            },
            "database": {
                name: "Database Layer",
                color: "#E91E63",  // Pink
                x: 30,
                y: 420,
                width: 300,
                height: 80
            },
            "messaging": {
                name: "Messaging Layer",
                color: "#FFC107",  // Amber
                x: 30,
                y: 540,
                width: 300,
                height: 80
            }
        };

        // Define component positions to match the new layer order
        const componentPositions = {
            "edge": {
                "cloudfront": { x: 95, y: 85 }
            },
            "monitoring": {
                "cloudwatch": { x: 260, y: 85 }
            },
            "api": {
                "api-gateway": { x: 95, y: 205 }
            },
            "security": {
                "cognito": { x: 260, y: 205 }
            },
            "compute": {
                "lambda": { x: 95, y: 325 }
            },
            "storage": {
                "s3": { x: 260, y: 325 }
            },
            "database": {
                "dynamodb": { x: 95, y: 445 },
                "redis": { x: 260, y: 445 }
            },
            "messaging": {
                "sqs": { x: 95, y: 565 },
                "sns": { x: 260, y: 565 }
            }
        };

        // Simulation stages definition with contextual task descriptions for SmartQuiz
        const stages = [
            {
                id: 1,
                name: "Set Up Database",
                description: "Configure a DynamoDB table for storing quiz data with appropriate capacity and indexes.",
                contextualDescription: "SmartQuiz needs a NoSQL database that supports low-latency read/write for quiz questions, user scores, and leaderboard rankings. Configure DynamoDB to support these requirements.",
                detailedInstructions: `
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-quiz-primary bg-opacity-10 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-quiz-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold">Task: Set up DynamoDB</h3>
                    </div>
                    
                    <p class="mb-4">SmartQuiz requires a flexible, high-performance database to store quiz questions, student answers, and real-time scoring data. As the cloud architect, you need to configure a NoSQL database that can handle fluctuating traffic patterns during quiz sessions while maintaining low latency for a smooth user experience.</p>
                    
                    <div class="instruction-section">
                        <h4 class="font-semibold text-quiz-primary dark:text-quiz-primary mb-2">Project Context</h4>
                        <p class="mb-2">The product team has identified that the SmartQuiz platform will experience varying load patterns:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>High traffic bursts during scheduled quiz sessions (hundreds of concurrent students)</li>
                            <li>Lower, steady traffic as teachers build and modify quizzes</li>
                            <li>Unpredictable spikes during semester exam periods</li>
                            <li>Need for fast leaderboard updates and real-time score calculations</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-important">
                        <h4 class="font-semibold mb-2">Key Requirements</h4>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Read Capacity: <span class="setting-highlight">5</span></span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Write Capacity: <span class="setting-highlight">10</span></span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Partition Key: <span class="setting-highlight">userId</span></span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg flex">
                        <svg class="h-6 w-6 text-blue-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-blue-800 dark:text-blue-200">
                            For this initial setup, we're using provisioned capacity with Read Capacity Units (RCUs) set to 5 and Write Capacity Units (WCUs) set to 10. The userId partition key will allow efficient lookups of user data, which is essential for quiz tracking and leaderboard functionality.
                        </p>
                    </div>
                `,
                requiredComponents: ["dynamodb"],
                enabledComponents: ["dynamodb"],
                validation: (config) => {
                    const dynamo = config.components.find(c => c.type === "dynamodb");
                    if (!dynamo) return false;
                    return dynamo.config["read-capacity"] === "5" && 
                           dynamo.config["write-capacity"] === "10" &&
                           dynamo.config["partition-key"] === "userId";
                },
                feedbackSuccess: "Great! Your DynamoDB configuration provides the flexible scaling needed for SmartQuiz's variable traffic patterns.",
                feedbackFail: "For this stage, you need to set Read Capacity to 5, Write Capacity to 10, and Partition Key to userId to match the requirements.",
                metrics: {
                    reliability: 40,
                    availability: 45,
                    latency: 300,
                    mttr: 45,
                    mttd: 20
                }
            },
            {
                id: 2,
                name: "Set Up Compute",
                description: "Add AWS Lambda functions to process quiz submissions and calculate scores.",
                contextualDescription: "SmartQuiz needs serverless compute to process quiz submissions, calculate scores, and update leaderboards. Configure Lambda with appropriate memory and concurrency settings.",
                detailedInstructions: `
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-quiz-primary bg-opacity-10 rounded-full flex items-center justify-center">
                            <div class="lambda-icon-bg" style="width: 28px; height: 28px;"><span class="lambda-icon-symbol" style="font-size: 22px;">λ</span></div>
                        </div>
                        <h3 class="text-lg font-bold">Task: Set up Lambda Functions</h3>
                    </div>
                    
                    <p class="mb-4">SmartQuiz needs backend compute power to process quiz submissions, calculate scores in real-time, and update leaderboards. As the cloud architect, you need to configure a serverless compute solution that can scale automatically during concurrent quiz sessions while maintaining low latency.</p>
                    
                    <div class="instruction-section">
                        <h4 class="font-semibold text-quiz-primary dark:text-quiz-primary mb-2">Project Context</h4>
                        <p class="mb-2">The development team has identified these compute requirements:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Quiz processing needs to handle multiple submissions simultaneously</li>
                            <li>Score calculations must execute in under 200ms for real-time feedback</li>
                            <li>Python is preferred for data processing and machine learning integration</li>
                            <li>Functions should be able to handle 1000+ concurrent quiz sessions during peak times</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-important">
                        <h4 class="font-semibold mb-2">Key Requirements</h4>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Runtime: <span class="setting-highlight">Python 3.8</span> or <span class="setting-highlight">Python 3.9</span></span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Memory: <span class="setting-highlight">512MB</span> or higher</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Concurrency: <span class="setting-highlight">1000 Reserved</span> or higher</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Region: <span class="setting-highlight">us-east-1</span></span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg flex">
                        <svg class="h-6 w-6 text-blue-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-blue-800 dark:text-blue-200">
                            Higher memory allocations provide more CPU power, which reduces execution time and improves the real-time experience. Reserved concurrency guarantees that your functions will be able to handle the specified number of simultaneous executions during peak quiz times.
                        </p>
                    </div>
                `,
                requiredComponents: ["dynamodb", "lambda"],
                enabledComponents: ["lambda"],
                validation: (config) => {
                    const lambda = config.components.find(c => c.type === "lambda");
                    if (!lambda) return false;
                    return (lambda.config.runtime === "Python 3.8" || lambda.config.runtime === "Python 3.9") && 
                           parseInt(lambda.config.memory) >= 512 &&
                           (lambda.config.concurrency === "1000 Reserved" || lambda.config.concurrency === "2000 Reserved" || lambda.config.concurrency === "Provisioned") &&
                           lambda.config.region === "us-east-1";
                },
                feedbackSuccess: "Excellent! Your Lambda configuration ensures responsive quiz processing with sufficient capacity for concurrent users.",
                feedbackFail: "Your Lambda function needs Python runtime, at least 512MB memory, and 1000+ concurrency to handle peak quiz loads.",
                metrics: {
                    reliability: 60,
                    availability: 65,
                    latency: 200,
                    mttr: 35,
                    mttd: 15
                }
            },
            {
                id: 3,
                name: "Create API Layer",
                description: "Set up API Gateway to securely expose quiz functionality to clients.",
                contextualDescription: "SmartQuiz requires a secure API layer to handle quiz interactions, user authentication, and real-time data exchange. Configure API Gateway with appropriate security and performance settings.",
                detailedInstructions: `
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-quiz-primary bg-opacity-10 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-quiz-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold">Task: Set up API Gateway</h3>
                    </div>
                    
                    <p class="mb-4">SmartQuiz needs a robust API layer to handle quiz submissions, real-time scoring, and user interactions. As the cloud architect, you need to configure an API Gateway that provides secure, managed access to backend Lambda functions with appropriate rate limiting and caching.</p>
                    
                    <div class="instruction-section">
                        <h4 class="font-semibold text-quiz-primary dark:text-quiz-primary mb-2">Project Context</h4>
                        <p class="mb-2">The product team has identified these API requirements:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Secure access to quiz functions from web and mobile clients</li>
                            <li>Rate limiting to prevent abuse and ensure fair access during peak periods</li>
                            <li>Caching of common quiz data to reduce backend load</li>
                            <li>Low-latency responses for real-time quiz interactions</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-important">
                        <h4 class="font-semibold mb-2">Key Requirements</h4>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Rate Limit: <span class="setting-highlight">1000</span> requests per second</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Caching: <span class="setting-highlight">0.5GB/30s TTL</span> or higher</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Auth Type: <span class="setting-highlight">Cognito</span> or <span class="setting-highlight">API Key</span></span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg flex">
                        <svg class="h-6 w-6 text-blue-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-blue-800 dark:text-blue-200">
                            Rate limiting ensures the API can handle many concurrent quiz sessions while preventing abuse. Caching improves performance by storing common quiz data. Authentication ensures only authorized students and teachers can access the appropriate quiz functions.
                        </p>
                    </div>
                `,
                requiredComponents: ["dynamodb", "lambda", "api-gateway"],
                enabledComponents: ["api-gateway"],
                validation: (config) => {
                    const apiGateway = config.components.find(c => c.type === "api-gateway");
                    if (!apiGateway) return false;
                    return (apiGateway.config["rate-limit"] === "1000" || 
                            apiGateway.config["rate-limit"] === "2000" || 
                            apiGateway.config["rate-limit"] === "5000" || 
                            apiGateway.config["rate-limit"] === "10000") && 
                           apiGateway.config["cache-enabled"] !== "Disabled" &&
                           (apiGateway.config["auth-type"] === "Cognito" || 
                            apiGateway.config["auth-type"] === "API Key");
                },
                feedbackSuccess: "Perfect! Your API Gateway configuration provides secure access with appropriate rate limiting and caching for quiz data.",
                feedbackFail: "For optimal performance, set rate limiting to at least 1000 requests per second, enable caching, and use Cognito or API Key authentication.",
                metrics: {
                    reliability: 75,
                    availability: 80,
                    latency: 150,
                    mttr: 25,
                    mttd: 10
                }
            },
            {
                id: 4,
                name: "Add Front-End Storage",
                description: "Configure S3 for storing static web assets and quiz content.",
                contextualDescription: "SmartQuiz needs a reliable storage solution for web assets, quiz images, and content. Set up S3 with proper access controls for web hosting.",
                detailedInstructions: `
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-quiz-primary bg-opacity-10 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-quiz-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold">Task: Set up S3 Storage</h3>
                    </div>
                    
                    <p class="mb-4">SmartQuiz requires a web-based frontend where students can attempt quizzes and teachers can manage them. As the cloud architect, you need to configure storage for static web assets, quiz images, and educational content that is both secure and globally accessible.</p>
                    
                    <div class="instruction-section">
                        <h4 class="font-semibold text-quiz-primary dark:text-quiz-primary mb-2">Project Context</h4>
                        <p class="mb-2">The frontend development team needs:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Reliable storage for HTML, CSS, and JavaScript files</li>
                            <li>Ability to host quiz images, diagrams, and educational media</li>
                            <li>Public read access for web assets</li>
                            <li>Version control for content to support rollbacks if needed</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-important">
                        <h4 class="font-semibold mb-2">Key Requirements</h4>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Access: <span class="setting-highlight">Public Read</span></span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Versioning: <span class="setting-highlight">Enabled</span></span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg flex">
                        <svg class="h-6 w-6 text-blue-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-blue-800 dark:text-blue-200">
                            Public Read access allows web browsers to directly access static content. Enabling versioning provides the ability to restore previous versions of quiz content and web assets if needed.
                        </p>
                    </div>
                `,
                requiredComponents: ["dynamodb", "lambda", "api-gateway", "s3"],
                enabledComponents: ["s3"],
                validation: (config) => {
                    const s3 = config.components.find(c => c.type === "s3");
                    if (!s3) return false;
                    return s3.config.access === "Public Read" && 
                           s3.config.versioning === "Enabled";
                },
                feedbackSuccess: "Great! Your S3 configuration provides public access for web content with versioning for content management.",
                feedbackFail: "For proper content hosting, ensure S3 is configured with Public Read access and Versioning enabled.",
                metrics: {
                    reliability: 85,
                    availability: 90,
                    latency: 120,
                    mttr: 20,
                    mttd: 8
                }
            },
            {
                id: 5,
                name: "Implement Authentication",
                description: "Set up Cognito for secure user authentication and authorization.",
                contextualDescription: "SmartQuiz requires secure login for students and teachers with different permission levels. Configure Cognito with MFA for teachers and appropriate session management.",
                detailedInstructions: `
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-quiz-primary bg-opacity-10 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-quiz-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold">Task: Set up Cognito</h3>
                    </div>
                    
                    <p class="mb-4">SmartQuiz requires secure login functionality to authenticate students and teachers while protecting sensitive quiz data and scores. As the cloud architect, you need to implement a user authentication system that supports different user roles with appropriate security levels.</p>
                    
                    <div class="instruction-section">
                        <h4 class="font-semibold text-quiz-primary dark:text-quiz-primary mb-2">Project Context</h4>
                        <p class="mb-2">The security team has identified these authentication requirements:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Separate roles for students and teachers with different permissions</li>
                            <li>Enhanced security for teacher accounts with access to grade data</li>
                            <li>Reasonable session timeouts to balance security and usability</li>
                            <li>Integration with the API Gateway for secure access control</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-important">
                        <h4 class="font-semibold mb-2">Key Requirements</h4>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>MFA: <span class="setting-highlight">OPTIONAL</span> or <span class="setting-highlight">REQUIRED</span></span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Token Expiry: <span class="setting-highlight">1 hour</span></span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg flex items-start border-l-4 border-green-400">
                        <svg class="h-6 w-6 text-green-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="text-sm text-green-800 dark:text-green-200 font-medium">Final Stage of Phase 1!</p>
                            <p class="text-sm text-green-700 dark:text-green-300 mt-1">
                                After completing this stage, you'll have built a complete, secure serverless application for SmartQuiz with all the core functionality needed for the quiz platform.
                            </p>
                        </div>
                    </div>
                `,
                requiredComponents: ["dynamodb", "lambda", "api-gateway", "s3", "cognito"],
                enabledComponents: ["cognito"],
                validation: (config) => {
                    const cognito = config.components.find(c => c.type === "cognito");
                    if (!cognito) return false;
                    return (cognito.config.mfa === "OPTIONAL" || cognito.config.mfa === "REQUIRED") && 
                           cognito.config["token-expiry"] === "1 hour";
                },
                feedbackSuccess: "Excellent! Your Cognito configuration provides secure authentication with appropriate session management for SmartQuiz users.",
                feedbackFail: "For proper user security, configure Cognito with MFA (OPTIONAL or REQUIRED) and 1-hour token expiry.",
                metrics: {
                    reliability: 95,
                    availability: 97,
                    latency: 100,
                    mttr: 15,
                    mttd: 5
                }
            },
            // Project Phase 2 stages
            {
                id: 1,
                phase: 2,
                name: "CloudFront for Content Delivery",
                description: "Set up CloudFront to distribute quiz content with low latency and high availability globally.",
                contextualDescription: "To deliver quiz content with low latency and high availability, SmartQuiz needs a content delivery network (CDN). Configure CloudFront to distribute quiz assets globally.",
                detailedInstructions: `
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-quiz-primary bg-opacity-10 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-quiz-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold">Task: Set up CloudFront</h3>
                    </div>
                    
                    <p class="mb-4">SmartQuiz is growing globally, with students and educators accessing the platform from various regions. To ensure fast content delivery and an optimal user experience worldwide, you need to configure CloudFront to distribute static content from your S3 bucket to edge locations closer to users.</p>
                    
                    <div class="instruction-section">
                        <h4 class="font-semibold text-quiz-primary dark:text-quiz-primary mb-2">Project Context</h4>
                        <p class="mb-2">The product team has identified these content delivery requirements:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Global distribution of quiz assets with minimal latency</li>
                            <li>Secure content delivery via HTTPS</li>
                            <li>Edge caching to reduce load on origin</li>
                            <li>Cost-effective distribution model for educational content</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-important">
                        <h4 class="font-semibold mb-2">Key Requirements</h4>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Origin: <span class="setting-highlight">S3 Website</span></span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Security: <span class="setting-highlight">HTTPS Only</span> or better</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Default TTL: <span class="setting-highlight">86400</span> or higher</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg flex">
                        <svg class="h-6 w-6 text-blue-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-blue-800 dark:text-blue-200">
                            CloudFront dramatically improves the end-user experience for globally distributed users by serving content from edge locations closer to them. Implementing HTTPS enhances security for educational content, while a longer TTL (Time To Live) ensures efficient caching of quiz resources that don't change frequently.
                        </p>
                    </div>
                `,
                requiredComponents: ["cloudfront", "s3"],
                enabledComponents: ["cloudfront"],
                validation: (config) => {
                    const cloudfront = config.components.find(c => c.type === "cloudfront");
                    if (!cloudfront) return false;
                    return cloudfront.config.origin === "S3 Website" && 
                           (cloudfront.config.security === "HTTPS Only" || 
                            cloudfront.config.security === "HTTPS + WAF" || 
                            cloudfront.config.security === "HTTPS + WAF + Field-Level Encryption") &&
                           (cloudfront.config.ttl === "86400" || 
                            cloudfront.config.ttl === "604800" || 
                            cloudfront.config.ttl === "2592000");
                },
                feedbackSuccess: "Excellent! Your CloudFront configuration will ensure low-latency delivery of quiz content to students globally while maintaining security with HTTPS.",
                feedbackFail: "To optimize global content delivery, make sure CloudFront is configured with an S3 Website origin, HTTPS security, and a TTL of at least 86400 seconds (1 day).",
                metrics: {
                    reliability: 97,
                    availability: 99,
                    latency: 50,
                    mttr: 12,
                    mttd: 4
                }
            },
            {
                id: 2,
                phase: 2,
                name: "CloudWatch for Monitoring",
                description: "Implement CloudWatch for monitoring and alerting on system health and performance.",
                contextualDescription: "To maintain system health and reliability, SmartQuiz needs comprehensive logging and performance metrics. Configure CloudWatch to monitor system performance and alert on issues.",
                detailedInstructions: `
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-quiz-primary bg-opacity-10 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-quiz-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold">Task: Set up CloudWatch</h3>
                    </div>
                    
                    <p class="mb-4">As SmartQuiz gains popularity, monitoring system health becomes crucial for maintaining a reliable platform. You need to implement comprehensive monitoring to track performance metrics, detect issues before they affect users, and ensure the platform is running smoothly during high-traffic periods like exam seasons.</p>
                    
                    <div class="instruction-section">
                        <h4 class="font-semibold text-quiz-primary dark:text-quiz-primary mb-2">Project Context</h4>
                        <p class="mb-2">The operations team has identified these monitoring requirements:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Real-time visibility into API response times and Lambda performance</li>
                            <li>Early detection of elevated error rates</li>
                            <li>Historical log retention for troubleshooting and audit purposes</li>
                            <li>Dashboards for visualizing key platform health indicators</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-important">
                        <h4 class="font-semibold mb-2">Key Requirements</h4>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Metrics Collection: <span class="setting-highlight">Detailed</span></span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Error Rate Alarm: <span class="setting-highlight">5%</span> or lower</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Log Retention: <span class="setting-highlight">1 month</span> or longer</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg flex">
                        <svg class="h-6 w-6 text-blue-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-blue-800 dark:text-blue-200">
                            Detailed metrics collection provides granular visibility into system performance, while setting error rate alarms at 5% or lower ensures you're promptly notified of potential issues. Storing logs for at least a month enables thorough investigation of user-reported problems and trend analysis.
                        </p>
                    </div>
                `,
                requiredComponents: ["cloudwatch"],
                enabledComponents: ["cloudwatch"],
                validation: (config) => {
                    const cloudwatch = config.components.find(c => c.type === "cloudwatch");
                    if (!cloudwatch) return false;
                    return cloudwatch.config.metrics === "Detailed" && 
                           (cloudwatch.config["alarm-threshold"] === "1%" || 
                            cloudwatch.config["alarm-threshold"] === "2%" || 
                            cloudwatch.config["alarm-threshold"] === "5%") &&
                           (cloudwatch.config["log-retention"] === "1 month" || 
                            cloudwatch.config["log-retention"] === "6 months" || 
                            cloudwatch.config["log-retention"] === "1 year");
                },
                feedbackSuccess: "Great job! Your CloudWatch configuration will provide comprehensive visibility into system health and alert you to potential issues before they impact users.",
                feedbackFail: "For effective monitoring, configure CloudWatch with Detailed metrics, error rate alarms at 5% or lower, and log retention of at least 1 month.",
                metrics: {
                    reliability: 99,
                    availability: 99.5,
                    latency: 45,
                    mttr: 8,
                    mttd: 2
                }
            },
            {
                id: 3,
                phase: 2,
                name: "SQS for Quiz Submissions",
                description: "Implement SQS to queue and process quiz submissions asynchronously.",
                contextualDescription: "To handle high-volume quiz submissions, SmartQuiz should process them asynchronously. Configure SQS to decouple the frontend from backend processing.",
                detailedInstructions: `
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-quiz-primary bg-opacity-10 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-quiz-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold">Task: Set up SQS for Asynchronous Processing</h3>
                    </div>
                    
                    <p class="mb-4">During high-traffic periods like midterms and finals, SmartQuiz experiences sudden surges in quiz submissions that can overwhelm the system. To ensure reliable processing and improve scalability, you need to implement a message queue that decouples quiz submission from processing.</p>
                    
                    <div class="instruction-section">
                        <h4 class="font-semibold text-quiz-primary dark:text-quiz-primary mb-2">Project Context</h4>
                        <p class="mb-2">The engineering team has identified these queue requirements:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Buffer for handling sudden spikes in quiz submissions</li>
                            <li>Reliable message delivery with at-least-once processing</li>
                            <li>Sufficient processing time for complex quiz scoring</li>
                            <li>Mechanism to handle failed processing attempts</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-important">
                        <h4 class="font-semibold mb-2">Key Requirements</h4>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Queue Type: <span class="setting-highlight">Standard</span></span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Visibility Timeout: <span class="setting-highlight">60 seconds</span> or higher</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Dead Letter Queue: <span class="setting-highlight">After 3 Retries</span> or higher</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg flex">
                        <svg class="h-6 w-6 text-blue-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-blue-800 dark:text-blue-200">
                            A Standard queue provides high throughput for processing quiz submissions in parallel, while a visibility timeout of 60+ seconds ensures sufficient time for processing complex submissions. Implementing a Dead Letter Queue after 3+ retries helps identify problematic submissions for manual review, preventing them from blocking the processing pipeline.
                        </p>
                    </div>
                `,
                requiredComponents: ["lambda", "sqs"],
                enabledComponents: ["sqs"],
                validation: (config) => {
                    const sqs = config.components.find(c => c.type === "sqs");
                    if (!sqs) return false;
                    return sqs.config["queue-type"] === "Standard" && 
                           (sqs.config["visibility-timeout"] === "60 seconds" || 
                            sqs.config["visibility-timeout"] === "5 minutes" || 
                            sqs.config["visibility-timeout"] === "15 minutes" || 
                            sqs.config["visibility-timeout"] === "30 minutes") &&
                           (sqs.config.dlq === "After 3 Retries" || 
                            sqs.config.dlq === "After 5 Retries" || 
                            sqs.config.dlq === "After 10 Retries");
                },
                feedbackSuccess: "Excellent! Your SQS configuration will effectively buffer quiz submissions during peak times and ensure reliable processing.",
                feedbackFail: "For effective asynchronous processing, configure SQS as a Standard queue with at least 60 seconds visibility timeout and a Dead Letter Queue after 3+ failed attempts.",
                metrics: {
                    reliability: 99.5,
                    availability: 99.8,
                    latency: 40,
                    mttr: 5,
                    mttd: 1
                }
            },
            {
                id: 4,
                phase: 2,
                name: "SNS for Notifications",
                description: "Implement SNS to send notifications about quiz results and system events.",
                contextualDescription: "SmartQuiz needs to keep users informed about quiz events, results, and platform announcements. Configure SNS to send timely notifications.",
                detailedInstructions: `
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-quiz-primary bg-opacity-10 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-quiz-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold">Task: Set up SNS for Notifications</h3>
                    </div>
                    
                    <p class="mb-4">Student engagement increases significantly when they receive timely notifications about quiz results, upcoming deadlines, and educational events. As the cloud architect, you need to implement a notification system that can reliably deliver messages across multiple channels such as email, SMS, and push notifications.</p>
                    
                    <div class="instruction-section">
                        <h4 class="font-semibold text-quiz-primary dark:text-quiz-primary mb-2">Project Context</h4>
                        <p class="mb-2">The product team has identified these notification requirements:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Immediate grade notifications when quizzes are scored</li>
                            <li>Reminders about upcoming assignment deadlines</li>
                            <li>Platform announcements about maintenance and new features</li>
                            <li>Flexible delivery options based on user preferences</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-important">
                        <h4 class="font-semibold mb-2">Key Requirements</h4>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Delivery Policy: <span class="setting-highlight">3 Retries</span> or more</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Subscribers: <span class="setting-highlight">Multiple Types</span> or <span class="setting-highlight">Email Only</span></span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg flex">
                        <svg class="h-6 w-6 text-blue-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-blue-800 dark:text-blue-200">
                            Setting a delivery policy with at least 3 retries ensures that important notifications aren't lost due to temporary delivery issues. Supporting multiple subscriber types allows users to receive notifications through their preferred channels, whether that's email, SMS, or mobile push notifications.
                        </p>
                    </div>
                `,
                requiredComponents: ["sns"],
                enabledComponents: ["sns"],
                validation: (config) => {
                    const sns = config.components.find(c => c.type === "sns");
                    if (!sns) return false;
                    return (sns.config["delivery-policy"] === "3 Retries" || 
                            sns.config["delivery-policy"] === "5 Retries" || 
                            sns.config["delivery-policy"] === "10 Retries") && 
                           (sns.config.subscribers === "Multiple Types" || 
                            sns.config.subscribers === "Email Only");
                },
                feedbackSuccess: "Perfect! Your SNS configuration will ensure reliable delivery of important notifications to users through their preferred channels.",
                feedbackFail: "For effective notifications, configure SNS with at least 3 delivery retries and support for either Multiple Types of subscribers or at minimum Email Only.",
                metrics: {
                    reliability: 99.9,
                    availability: 99.9,
                    latency: 35,
                    mttr: 4,
                    mttd: 1
                }
            },
            {
                id: 5,
                phase: 2,
                name: "Redis for Caching",
                description: "Implement Redis for caching frequently accessed quiz data to reduce database load and improve response times.",
                contextualDescription: "Due to increasing user load, SmartQuiz needs a caching layer to store frequently accessed data. Configure Redis to improve response times and reduce database load.",
                detailedInstructions: `
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-quiz-primary bg-opacity-10 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-quiz-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold">Task: Set up Redis for Caching</h3>
                    </div>
                    
                    <p class="mb-4">As SmartQuiz grows to serve more students, the database is experiencing increased load, especially for popular quizzes and leaderboards. To improve performance and reduce costs, you need to implement a caching layer for frequently accessed data.</p>
                    
                    <div class="instruction-section">
                        <h4 class="font-semibold text-quiz-primary dark:text-quiz-primary mb-2">Project Context</h4>
                        <p class="mb-2">The performance team has identified these caching needs:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Caching of popular quizzes and their questions</li>
                            <li>Session data storage for active users</li>
                            <li>Leaderboard caching for real-time score displays</li>
                            <li>Reliable cache with protection against data loss</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-important">
                        <h4 class="font-semibold mb-2">Key Requirements</h4>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Instance Type: <span class="setting-highlight">cache.t3.small</span> or larger</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Auto Failover: <span class="setting-highlight">Enabled</span></span>
                            </li>
                            <li class="flex items-start">
                                <svg class="h-5 w-5 text-quiz-primary mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Number of Nodes: <span class="setting-highlight">2</span> or more</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg flex items-start border-l-4 border-green-400">
                        <svg class="h-6 w-6 text-green-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="text-sm text-green-800 dark:text-green-200 font-medium">Final Stage of Phase 2!</p>
                            <p class="text-sm text-green-700 dark:text-green-300 mt-1">
                                After completing this stage, you'll have enhanced the SmartQuiz platform with global content delivery, monitoring, asynchronous processing, notifications, and caching - creating a robust, scalable, and performant architecture.
                            </p>
                        </div>
                    </div>
                `,
                requiredComponents: ["dynamodb", "redis"],
                enabledComponents: ["redis"],
                validation: (config) => {
                    const redis = config.components.find(c => c.type === "redis");
                    if (!redis) return false;
                    return (redis.config["instance-type"] === "cache.t3.small" || 
                            redis.config["instance-type"] === "cache.m5.large" || 
                            redis.config["instance-type"] === "cache.r5.large" || 
                            redis.config["instance-type"] === "cache.r5.xlarge") && 
                           redis.config["auto-failover"] === "Enabled" &&
                           parseInt(redis.config.nodes) >= 2;
                },
                feedbackSuccess: "Great job! Your Redis configuration will dramatically improve performance for frequently accessed data while ensuring high availability with auto failover.",
                feedbackFail: "For effective caching, configure Redis with at least a cache.t3.small instance, Auto Failover Enabled, and 2 or more nodes.",
                metrics: {
                    reliability: 99.95,
                    availability: 99.95,
                    latency: 25,
                    mttr: 3,
                    mttd: 1
                }
            }
        ];

        // Initialize application
        function init() {
            initDarkMode();
            initializeComponentDropdown();
            updateStageInstructions();
            renderArchitecture();
            checkAllComponentsComplete();
            
            // Register event listeners
            registerEventListeners();
            
            // Add resize handler for responsiveness
            window.addEventListener('resize', handleResize);
            
            // Show the initial instructions modal
            showInstructionsModal();
        }

        // Initialize component dropdown
        function initializeComponentDropdown() {
            const selectElement = document.getElementById('component-layer-select');
            
            // Clear existing options
            selectElement.innerHTML = '';
            
            // Get all unique layers
            const layers = [...new Set(Object.values(componentsData).map(comp => comp.layer))];
            
            // Create default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Select Component Layer --';
            selectElement.appendChild(defaultOption);
            
            // Add options for each layer
            layers.forEach(layer => {
                const option = document.createElement('option');
                option.value = layer;
                option.textContent = layer.charAt(0).toUpperCase() + layer.slice(1) + ' Layer';
                selectElement.appendChild(option);
            });
            
            // Add change event listener
            selectElement.addEventListener('change', (event) => {
                const selectedLayer = event.target.value;
                if (selectedLayer) {
                    populateComponentsForLayer(selectedLayer);
                } else {
                    // Clear component list if no layer is selected
                    document.getElementById('component-list').innerHTML = '';
                }
            });
        }

        // Populate components for a specific layer
        function populateComponentsForLayer(layer) {
            const componentList = document.getElementById('component-list');
            componentList.innerHTML = '';
            
            // Get components for this layer
            const layerComponents = Object.entries(componentsData)
                .filter(([_, comp]) => comp.layer === layer)
                .map(([key, comp]) => ({ key, ...comp }));
            
            // Get enabled components for current stage
            const currentStageData = stages[state.currentStage - 1];
            const enabledComponents = currentStageData.enabledComponents || [];
            
            if (layerComponents.length === 0) {
                componentList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">No components available in this layer</p>';
                return;
            }
            
            // Create component cards
            layerComponents.forEach(comp => {
                const compCard = document.createElement('div');
                compCard.className = 'component-card p-2 border rounded cursor-pointer flex flex-row items-center mb-2 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
                
                // Add disabled class if not enabled for this stage
                if (!enabledComponents.includes(comp.key)) {
                    compCard.classList.add('disabled');
                }
                
                compCard.dataset.component = comp.key;
                
                compCard.innerHTML = `
                    <div class="icon text-quiz-primary dark:text-quiz-primary mr-3 flex-shrink-0">${comp.icon}</div>
                    <div class="flex flex-col text-left">
                        <div class="name text-sm font-semibold">${comp.name}</div>
                        <div class="description text-xs text-gray-500 dark:text-gray-400">${comp.description}</div>
                    </div>
                `;
                
                // Only add click event if the component is enabled
                if (enabledComponents.includes(comp.key)) {
                    compCard.addEventListener('click', () => {
                        selectComponent(comp.key);
                    });
                }
                
                componentList.appendChild(compCard);
            });
        }

        // Handle window resize for responsiveness
        function handleResize() {
            renderArchitecture();
        }

        // Register all event listeners
        function registerEventListeners() {
            document.getElementById('apply-btn').addEventListener('click', applyConfiguration);
            document.getElementById('close-modal').addEventListener('click', hideInstructionsModal);
            document.getElementById('start-stage').addEventListener('click', hideInstructionsModal);
            document.getElementById('instructions-btn').addEventListener('click', showInstructionsModal);
            document.getElementById('phase-complete-btn').addEventListener('click', hidePhaseCompletionModal);
            document.getElementById('game-complete-btn').addEventListener('click', hideGameCompletionModal);
        }

        // Select a component
        function selectComponent(componentKey) {
            // Reset all component cards
            document.querySelectorAll('.component-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Mark the selected card
            document.querySelector(`.component-card[data-component="${componentKey}"]`).classList.add('selected');
            
            // Update selected component
            state.selectedComponent = componentKey;
            
            // Generate configuration form
            generateConfigForm(componentKey);
        }

        // Generate configuration form
        function generateConfigForm(componentKey) {
            const configForm = document.getElementById('configuration-form');
            configForm.innerHTML = '';
            
            const component = componentsData[componentKey];
            
            // Check if component is already configured
            const existingConfig = state.appliedComponents.find(c => c.type === componentKey)?.config || {};
            
            // Store current metrics for preview comparison
            state.previousMetrics = getDisplayedMetrics();
            
            component.configOptions.forEach(option => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.className = 'block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1';
                label.setAttribute('for', option.name);
                label.textContent = option.label;
                
                let input;
                
                if (option.type === 'select') {
                    input = document.createElement('select');
                    input.className = 'w-full p-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs';
                    
                    option.options.forEach(optionValue => {
                        const optionElement = document.createElement('option');
                        optionElement.value = optionValue;
                        optionElement.textContent = optionValue;
                        
                        if (existingConfig[option.name] === optionValue) {
                            optionElement.selected = true;
                        }
                        
                        input.appendChild(optionElement);
                    });
                } else if (option.type === 'text') {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-full p-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs';
                    input.placeholder = option.placeholder || '';
                    
                    if (existingConfig[option.name]) {
                        input.value = existingConfig[option.name];
                    }
                }
                
                input.id = option.name;
                input.name = option.name;
                
                formGroup.appendChild(label);
                formGroup.appendChild(input);
                configForm.appendChild(formGroup);
            });
            
            // Enable the apply button
            document.getElementById('apply-btn').disabled = false;
            document.getElementById('apply-btn').classList.remove('btn-disabled');
        }
        
        // Check if all components are complete
        function checkAllComponentsComplete() {
            // Get the required components for current phase
            const currentPhase = stages[state.currentStage - 1].phase || 1;
            const allRequiredComponents = new Set();
            
            // Get components required for the current phase only
            stages.filter(stage => (stage.phase || 1) === currentPhase)
                .forEach(stage => {
                    stage.requiredComponents.forEach(comp => {
                        allRequiredComponents.add(comp);
                    });
                });
            
            // Check if all required components for this phase are in the completed components list
            const completedComponentTypes = state.completedComponents.map(c => c.type);
            const allComplete = Array.from(allRequiredComponents).every(comp => completedComponentTypes.includes(comp));
            
            // Update state
            const wasAlreadyComplete = state.allComponentsComplete;
            state.allComponentsComplete = allComplete;
            
            // Show metrics panel when phase 1 is complete (all 5 initial components)
            const metricsPanel = document.getElementById('metrics-panel');
            // Check if we've completed all of phase 1 (first 5 stages)
            const phase1Complete = ["dynamodb", "lambda", "api-gateway", "s3", "cognito"].every(comp => 
                completedComponentTypes.includes(comp)
            );
            
            if (phase1Complete) {
                metricsPanel.classList.remove('hidden');
                updateMetrics();
            } else {
                metricsPanel.classList.add('hidden');
            }
        }
        
        // Show project phase completion modal
        function showPhaseCompletionModal() {
            const modal = document.getElementById('phase-completion-modal');
            
            // Update summary metrics in the modal
            document.getElementById('summary-reliability').textContent = document.getElementById('metric-reliability').textContent;
            document.getElementById('summary-bar-reliability').style.width = document.getElementById('bar-reliability').style.width;
            
            document.getElementById('summary-availability').textContent = document.getElementById('metric-availability').textContent;
            document.getElementById('summary-bar-availability').style.width = document.getElementById('bar-availability').style.width;
            
            document.getElementById('summary-latency').textContent = document.getElementById('metric-latency').textContent;
            document.getElementById('summary-bar-latency').style.width = `${100 - parseInt(document.getElementById('bar-latency').style.width)}%`;
            
            document.getElementById('summary-security').textContent = document.getElementById('metric-security').textContent;
            document.getElementById('summary-bar-security').style.width = document.getElementById('bar-security').style.width;
            
            // Show the modal
            modal.classList.add('show');
        }
        
        // Hide phase completion modal
        function hidePhaseCompletionModal() {
            const modal = document.getElementById('phase-completion-modal');
            modal.classList.remove('show');
        }
        
        // Show game completion modal at the end of Phase 2
        function showGameCompletionModal() {
            const modal = document.getElementById('game-completion-modal');
            
            // Update final metrics in the modal
            document.getElementById('final-reliability').textContent = document.getElementById('metric-reliability').textContent;
            document.getElementById('final-availability').textContent = document.getElementById('metric-availability').textContent;
            document.getElementById('final-latency').textContent = document.getElementById('metric-latency').textContent;
            document.getElementById('final-security').textContent = document.getElementById('metric-security').textContent;
            document.getElementById('final-users').textContent = document.getElementById('metric-users').textContent;
            document.getElementById('final-satisfaction').textContent = document.getElementById('metric-satisfaction').textContent;
            
            // Show the modal
            modal.classList.add('show');
        }
        
        // Hide game completion modal
        function hideGameCompletionModal() {
            const modal = document.getElementById('game-completion-modal');
            modal.classList.remove('show');
        }
        
        // Apply configuration
        function applyConfiguration() {
            if (!state.selectedComponent) return;
            
            const configForm = document.getElementById('configuration-form');
            const config = {};
            
            // Manually collect form values
            const inputs = configForm.querySelectorAll('input, select');
            inputs.forEach(input => {
                config[input.name] = input.value;
            });
            
            // Find if component already exists
            const existingIndex = state.appliedComponents.findIndex(c => c.type === state.selectedComponent);
            
            if (existingIndex >= 0) {
                // Update existing component
                state.appliedComponents[existingIndex].config = config;
            } else {
                // Add new component
                state.appliedComponents.push({
                    type: state.selectedComponent,
                    config: config
                });
            }
            
            // Re-render architecture
            renderArchitecture();
            
            // Validate stage completion
            validateStage();
            
            // Reset selection
            resetSelection();
            
            // Check if all components are complete
            checkAllComponentsComplete();
        }

        // Reset component selection but preserve the configuration panel
        function resetSelection() {
            // Don't reset the selected component or clear the configuration panel
            
            // Disable the apply button until next time, but keep its original appearance
            document.getElementById('apply-btn').disabled = true;
            
            // Add change event listeners to all form fields to re-enable the Apply button
            const configForm = document.getElementById('configuration-form');
            const inputs = configForm.querySelectorAll('input, select');
            
            inputs.forEach(input => {
                input.addEventListener('change', enableApplyButton);
            });
        }
        
        // Function to enable the Apply button when changes are made
        function enableApplyButton() {
            document.getElementById('apply-btn').disabled = false;
            document.getElementById('apply-btn').classList.remove('btn-disabled');
        }

        // Validate stage completion
        function validateStage() {
            const currentStageData = stages[state.currentStage - 1];
            
            // Check if all required components are present
            const hasAllComponents = currentStageData.requiredComponents.every(comp => 
                state.appliedComponents.some(c => c.type === comp)
            );
            
            if (!hasAllComponents) {
                provideFeedback(false, `You need to add all required components for this stage: ${currentStageData.requiredComponents.map(c => componentsData[c].name).join(', ')}`);
                
                // Re-enable the apply button to let user try again
                document.getElementById('apply-btn').disabled = false;
                document.getElementById('apply-btn').classList.remove('btn-disabled');
                return;
            }
            
            // Validate configuration
            const isValid = currentStageData.validation({
                components: state.appliedComponents
            });
            
            if (isValid) {
                provideFeedback(true, currentStageData.feedbackSuccess);
                
                // Track successfully completed components
                const latestComponent = state.appliedComponents.find(c => 
                    currentStageData.requiredComponents.includes(c.type) && 
                    !state.completedComponents.some(cc => cc.type === c.type)
                );
                
                if (latestComponent) {
                    state.completedComponents.push(latestComponent);
                }
                
                // Increment completed stages counter
                state.stagesCompleted++;
                
                // Hide configuration after successful completion
                const configForm = document.getElementById('configuration-form');
                configForm.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">Task completed! Select another component to configure.</p>';
                
                // Reset selected component
                state.selectedComponent = null;
                
                // Reset component selection
                document.querySelectorAll('.component-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Store current metrics for comparison
                state.previousMetrics = getDisplayedMetrics();
                
                // Update project phase counter if needed
                if (currentStageData.phase) {
                    document.getElementById('project-day-counter').textContent = currentStageData.phase;
                    document.getElementById('info-phase-number').textContent = currentStageData.phase;
                    document.getElementById('modal-project-day').textContent = currentStageData.phase;
                }
                
                // Show completion modal with updated stats
                showCompletionModal(currentStageData);
                
                // Check if this is the last stage of Phase 1 and we haven't shown the phase 1 completion modal yet
                if (currentStageData.id === 5 && !currentStageData.phase && !state.showedPhase1Completion) {
                    // Set flag to prevent showing it multiple times
                    state.showedPhase1Completion = true;
                    
                    document.getElementById('continue-btn').addEventListener('click', () => {
                        hideCompletionModal();
                        showPhaseCompletionModal();
                        
                        // Add event listener to the continue button in the phase completion modal to progress to next stage
                        document.getElementById('phase-complete-btn').addEventListener('click', () => {
                            hidePhaseCompletionModal();
                            state.currentStage++;
                            updateStageInstructions();
                            initializeComponentDropdown();
                            renderArchitecture();
                            checkAllComponentsComplete();
                            showInstructionsModal();
                        }, { once: true });
                    }, { once: true });
                }
                // Check if this is the last stage of Phase 2
                else if (currentStageData.phase === 2 && currentStageData.id === 5) {
                    document.getElementById('continue-btn').addEventListener('click', () => {
                        hideCompletionModal();
                        showGameCompletionModal();
                    }, { once: true });
                }
                // Handle normal progression between stages
                else if (state.currentStage < stages.length) {
                    document.getElementById('continue-btn').addEventListener('click', () => {
                        hideCompletionModal();
                        state.currentStage++;
                        updateStageInstructions();
                        initializeComponentDropdown(); // Update enabled components
                        document.getElementById('component-list').innerHTML = ''; // Clear component list
                        renderArchitecture(); // Re-render to show completed components
                        checkAllComponentsComplete(); // Check if all components are complete
                        showInstructionsModal(); // Show instructions for new stage
                    }, { once: true });
                } else {
                    document.getElementById('continue-btn').addEventListener('click', hideCompletionModal, { once: true });
                }
            } else {
                provideFeedback(false, currentStageData.feedbackFail);
                
                // Re-enable the apply button to let user try again with different settings
                document.getElementById('apply-btn').disabled = false;
                document.getElementById('apply-btn').classList.remove('btn-disabled');
            }
        }
        
        // Get currently displayed metrics for comparison
        function getDisplayedMetrics() {
            return {
                reliability: document.getElementById('metric-reliability').textContent,
                availability: document.getElementById('metric-availability').textContent,
                latency: document.getElementById('metric-latency').textContent,
                users: document.getElementById('metric-users').textContent,
                satisfaction: document.getElementById('metric-satisfaction').textContent,
                scalability: document.getElementById('metric-scalability').textContent,
                performance: document.getElementById('metric-performance').textContent,
                security: document.getElementById('metric-security').textContent,
                cost: document.getElementById('metric-cost').textContent
            };
        }
        
        // Show completion modal with stats and timeline
        function showCompletionModal(stageData) {
            const modal = document.getElementById('completion-modal');
            const taskName = document.getElementById('completion-task-name');
            const description = document.getElementById('completion-description');
            const projectDay = document.getElementById('modal-project-day');
            const metricChanges = document.getElementById('metric-changes');
            const timelineDescription = document.getElementById('timeline-description');
            
            // Update basic information
            taskName.textContent = stageData.name;
            description.textContent = stageData.feedbackSuccess;
            projectDay.textContent = stageData.phase || "1";
            
            // Calculate metric changes
            const newMetrics = getDisplayedMetrics();
            metricChanges.innerHTML = '';
            
            // Track significant changes to mention in timeline
            const significantChanges = [];
            
            if (state.previousMetrics.reliability) {
                // Add metric comparison rows with change indicators
                addMetricChangeRow('Reliability', state.previousMetrics.reliability, newMetrics.reliability, 'green');
                addMetricChangeRow('Availability', state.previousMetrics.availability, newMetrics.availability, 'blue');
                addMetricChangeRow('Latency', state.previousMetrics.latency, newMetrics.latency, 'yellow', true);
                addMetricChangeRow('Active Users', state.previousMetrics.users, newMetrics.users, 'indigo');
                addMetricChangeRow('Satisfaction', state.previousMetrics.satisfaction, newMetrics.satisfaction, 'pink');
                
                // Track significant changes
                const reliabilityOld = parseInt(state.previousMetrics.reliability);
                const reliabilityNew = parseInt(newMetrics.reliability);
                if (reliabilityNew - reliabilityOld >= 15) {
                    significantChanges.push(`reliability improved by ${reliabilityNew - reliabilityOld}%`);
                }
                
                const latencyOld = parseInt(state.previousMetrics.latency);
                const latencyNew = parseInt(newMetrics.latency);
                if (latencyOld - latencyNew >= 100) {
                    significantChanges.push(`latency decreased by ${latencyOld - latencyNew}ms`);
                }
                
                if (state.previousMetrics.security !== newMetrics.security) {
                    significantChanges.push(`security level increased to ${newMetrics.security}`);
                }
            } else {
                // First stage, show initial metrics without comparisons
                addInitialMetricRow('Reliability', newMetrics.reliability, 'green');
                addInitialMetricRow('Availability', newMetrics.availability, 'blue');
                addInitialMetricRow('Latency', newMetrics.latency, 'yellow');
                addInitialMetricRow('Active Users', newMetrics.users, 'indigo');
            }
            
            // Generate timeline event based on the stage
            const phase = stageData.phase || 1;
            const timelineEvents = [
                `Phase ${phase}: Started implementing ${stageData.name.toLowerCase()}.`,
                `Phase ${phase}: Successfully completed ${stageData.name.toLowerCase()}.`
            ];
            
            // Add significant changes if any
            if (significantChanges.length > 0) {
                timelineEvents.push(`Key improvements: ${significantChanges.join(', ')}.`);
            }
            
            timelineDescription.innerHTML = timelineEvents.join('<br>');
            
            // Show the modal
            modal.classList.add('show');
        }
        
        // Hide completion modal
        function hideCompletionModal() {
            const modal = document.getElementById('completion-modal');
            modal.classList.remove('show');
        }
        
        // Add a metric change row to the completion modal
        function addMetricChangeRow(metricName, oldValue, newValue, color, isReversed = false) {
            const metricChanges = document.getElementById('metric-changes');
            
            // Create row element
            const row = document.createElement('div');
            row.className = 'col-span-2 grid grid-cols-12 items-center border-b border-gray-100 dark:border-gray-800 pb-2';
            
            // Determine status (increased, decreased, or no change)
            let status = 'nochange';
            let changeIcon = '';
            let statusLabel = '';
            let statusClass = '';
            
            // Extract numbers for comparison
            const extractNumber = (val) => {
                if (typeof val === 'string') {
                    return parseFloat(val.replace(/[^0-9.]/g, ''));
                }
                return val;
            };
            
            if (isReversed) {
                // For metrics like latency where lower is better
                const oldNum = extractNumber(oldValue);
                const newNum = extractNumber(newValue);
                
                if (newNum < oldNum) {
                    status = 'improved';
                    changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>`;
                    statusLabel = 'Decreased';
                    statusClass = 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300';
                } else if (newNum > oldNum) {
                    status = 'worse';
                    changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>`;
                    statusLabel = 'Increased';
                    statusClass = 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300';
                } else {
                    status = 'nochange';
                    changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>`;
                    statusLabel = 'No Change';
                    statusClass = 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400';
                }
            } else {
                // For regular metrics where higher is better
                if (oldValue.includes('%') && newValue.includes('%')) {
                    // Percentage comparison
                    const oldNum = parseInt(oldValue);
                    const newNum = parseInt(newValue);
                    
                    if (newNum > oldNum) {
                        status = 'improved';
                        changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>`;
                        statusLabel = 'Increased';
                        statusClass = 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300';
                    } else if (newNum < oldNum) {
                        status = 'worse';
                        changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>`;
                        statusLabel = 'Decreased';
                        statusClass = 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300';
                    } else {
                        status = 'nochange';
                        changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                        </svg>`;
                        statusLabel = 'No Change';
                        statusClass = 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400';
                    }
                } else if (!isNaN(extractNumber(oldValue)) && !isNaN(extractNumber(newValue))) {
                    // Numeric comparison
                    const oldNum = extractNumber(oldValue);
                    const newNum = extractNumber(newValue);
                    
                    if (newNum > oldNum) {
                        status = 'improved';
                        changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>`;
                        statusLabel = 'Increased';
                        statusClass = 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300';
                    } else if (newNum < oldNum) {
                        status = 'worse';
                        changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>`;
                        statusLabel = 'Decreased';
                        statusClass = 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300';
                    } else {
                        status = 'nochange';
                        changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                        </svg>`;
                        statusLabel = 'No Change';
                        statusClass = 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400';
                    }
                } else {
                    // String comparison (like "Low" to "Medium")
                    const levels = ["Low", "Basic", "Fair", "Moderate", "Medium", "Good", "High", "Excellent"];
                    const oldIndex = levels.indexOf(oldValue);
                    const newIndex = levels.indexOf(newValue);
                    
                    if (newIndex > oldIndex && oldIndex !== -1 && newIndex !== -1) {
                        status = 'improved';
                        changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>`;
                        statusLabel = 'Improved';
                        statusClass = 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300';
                    } else if (newIndex < oldIndex && oldIndex !== -1 && newIndex !== -1) {
                        status = 'worse';
                        changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>`;
                        statusLabel = 'Reduced';
                        statusClass = 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300';
                    } else {
                        status = 'nochange';
                        changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                        </svg>`;
                        statusLabel = 'No Change';
                        statusClass = 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400';
                    }
                }
            }
            
            // For special case: cost metric
            if (metricName === 'Cost') {
                const oldCost = extractNumber(oldValue);
                const newCost = extractNumber(newValue);
                
                if (newCost > oldCost) {
                    changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>`;
                    statusLabel = 'Increased';
                    statusClass = 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300';
                } else if (newCost < oldCost) {
                    changeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>`;
                    statusLabel = 'Decreased';
                    statusClass = 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300';
                }
            }
            
            // Calculate change value if numeric
            let changeValue = '';
            if (!isNaN(extractNumber(oldValue)) && !isNaN(extractNumber(newValue)) && status !== 'nochange') {
                const oldNum = extractNumber(oldValue);
                const newNum = extractNumber(newValue);
                const diff = isReversed ? (oldNum - newNum) : (newNum - oldNum);
                
                if (oldValue.includes('%')) {
                    changeValue = `(${diff > 0 ? '+' : ''}${diff}%)`;
                } else if (oldValue.includes('ms')) {
                    changeValue = `(${diff > 0 ? '+' : ''}${diff}ms)`;
                } else if (metricName === 'Cost') {
                    changeValue = `(${diff > 0 ? '+' : ''}$${diff.toFixed(0)})`;
                } else if (!isNaN(diff)) {
                    changeValue = `(${diff > 0 ? '+' : ''}${diff})`;
                }
            }
            
            // Generate HTML
            row.innerHTML = `
                <div class="col-span-3 font-medium text-gray-700 dark:text-gray-300">${metricName}:</div>
                <div class="col-span-3 text-gray-500 dark:text-gray-400">${oldValue}</div>
                <div class="col-span-1 flex justify-center">
                    ${changeIcon}
                </div>
                <div class="col-span-3 font-semibold">
                    ${newValue}
                    ${changeValue ? `<span class="text-xs ml-1 font-normal ${status === 'improved' ? 'text-green-600 dark:text-green-400' : status === 'worse' ? 'text-red-600 dark:text-red-400' : 'text-blue-600 dark:text-blue-400'}">${changeValue}</span>` : ''}
                </div>
                <div class="col-span-2 flex justify-end">
                    <span class="px-2 py-1 ${statusClass} text-xs rounded-full">${statusLabel}</span>
                </div>
            `;
            
            metricChanges.appendChild(row);
        }
        
        // Add an initial metric row (for first stage with no comparisons)
        function addInitialMetricRow(metricName, value, color) {
            const metricChanges = document.getElementById('metric-changes');
            
            // Create row element
            const row = document.createElement('div');
            row.className = 'col-span-2 grid grid-cols-8 items-center border-b border-gray-100 dark:border-gray-800 pb-2';
            
            // Generate HTML
            row.innerHTML = `
                <div class="col-span-3 font-medium text-gray-700 dark:text-gray-300">${metricName}:</div>
                <div class="col-span-3 font-semibold">${value}</div>
                <div class="col-span-2 flex justify-end">
                    <span class="px-2 py-1 bg-${color}-100 dark:bg-${color}-900/30 text-${color}-800 dark:text-${color}-300 text-xs rounded-full">Baseline</span>
                </div>
            `;
            
            metricChanges.appendChild(row);
        }

        // Provide feedback
        function provideFeedback(success, message) {
            const feedbackContainer = document.getElementById('feedback-container');
            const feedbackMessage = document.getElementById('feedback-message');
            
            feedbackContainer.className = success 
                ? 'panel mt-3 p-3 bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200 rounded' 
                : 'panel mt-3 p-3 bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200 rounded';
            
            feedbackMessage.textContent = message;
        }

        // Update stage instructions and key requirements
        function updateStageInstructions() {
            const stageNumber = document.getElementById('current-stage');
            const stageName = document.getElementById('stage-name');
            const keyRequirements = document.getElementById('key-requirements');
            const infoStageNumber = document.getElementById('info-stage-number');
            const infoStageName = document.getElementById('info-stage-name');
            const stageInfoDescription = document.getElementById('stage-info-description');
            const infoPhaseNumber = document.getElementById('info-phase-number');
            
            const currentStageData = stages[state.currentStage - 1];
            
            // Update phase number if applicable
            if (currentStageData.phase) {
                infoPhaseNumber.textContent = currentStageData.phase;
            } else {
                infoPhaseNumber.textContent = "1";
            }
            
            // Update header stage info
            stageNumber.textContent = currentStageData.id;
            stageName.textContent = currentStageData.name;
            
            // Update info panel stage info
            infoStageNumber.textContent = currentStageData.id;
            infoStageName.textContent = currentStageData.name;
            
            // Update stage description in the info panel
            if (currentStageData.contextualDescription) {
                stageInfoDescription.textContent = currentStageData.contextualDescription;
            } else {
                stageInfoDescription.textContent = currentStageData.description;
            }
            
            // Extract key requirements from the detailed instructions
            keyRequirements.innerHTML = '';
            
            // Extract key requirements based on the stage and phase
            if (currentStageData.phase === 2) {
                // Phase 2 stages
                if (currentStageData.id === 1) {
                    // CloudFront
                    addKeyRequirement(keyRequirements, "Origin: S3 Website");
                    addKeyRequirement(keyRequirements, "Security: HTTPS Only or better");
                    addKeyRequirement(keyRequirements, "Default TTL: 86400 or higher");
                } else if (currentStageData.id === 2) {
                    // CloudWatch
                    addKeyRequirement(keyRequirements, "Metrics Collection: Detailed");
                    addKeyRequirement(keyRequirements, "Error Rate Alarm: 5% or lower");
                    addKeyRequirement(keyRequirements, "Log Retention: 1 month or longer");
                } else if (currentStageData.id === 3) {
                    // SQS
                    addKeyRequirement(keyRequirements, "Queue Type: Standard");
                    addKeyRequirement(keyRequirements, "Visibility Timeout: 60 seconds or higher");
                    addKeyRequirement(keyRequirements, "Dead Letter Queue: After 3 Retries or higher");
                } else if (currentStageData.id === 4) {
                    // SNS
                    addKeyRequirement(keyRequirements, "Delivery Policy: 3 Retries or more");
                    addKeyRequirement(keyRequirements, "Subscribers: Multiple Types or Email Only");
                } else if (currentStageData.id === 5) {
                    // Redis
                    addKeyRequirement(keyRequirements, "Instance Type: cache.t3.small or larger");
                    addKeyRequirement(keyRequirements, "Auto Failover: Enabled");
                    addKeyRequirement(keyRequirements, "Number of Nodes: 2 or more");
                }
            } else {
                // Phase 1 stages
                if (currentStageData.id === 1) {
                    // Stage 1: DynamoDB
                    addKeyRequirement(keyRequirements, "Read Capacity: 5");
                    addKeyRequirement(keyRequirements, "Write Capacity: 10");
                    addKeyRequirement(keyRequirements, "Partition Key: userId");
                } else if (currentStageData.id === 2) {
                    // Stage 2: Lambda
                    addKeyRequirement(keyRequirements, "Runtime: Python 3.8 or Python 3.9");
                    addKeyRequirement(keyRequirements, "Memory: 512MB or higher");
                    addKeyRequirement(keyRequirements, "Concurrency: 1000 Reserved or higher");
                    addKeyRequirement(keyRequirements, "Region: us-east-1");
                } else if (currentStageData.id === 3) {
                    // Stage 3: API Gateway
                    addKeyRequirement(keyRequirements, "Rate Limit: 1000 requests/sec or higher");
                    addKeyRequirement(keyRequirements, "Caching: 0.5GB/30s TTL or higher");
                    addKeyRequirement(keyRequirements, "Auth Type: Cognito or API Key");
                } else if (currentStageData.id === 4) {
                    // Stage 4: S3
                    addKeyRequirement(keyRequirements, "Access: Public Read");
                    addKeyRequirement(keyRequirements, "Versioning: Enabled");
                } else if (currentStageData.id === 5) {
                    // Stage 5: Cognito
                    addKeyRequirement(keyRequirements, "MFA: OPTIONAL or REQUIRED");
                    addKeyRequirement(keyRequirements, "Token Expiry: 1 hour");
                }
            }
        }
        
        // Helper function to add a key requirement with styling
        function addKeyRequirement(container, text) {
            const item = document.createElement('div');
            item.className = 'flex items-start text-sm font-medium';
            item.innerHTML = `
                <svg class="h-5 w-5 text-blue-500 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-blue-800 dark:text-blue-200">${text}</span>
            `;
            container.appendChild(item);
        }

        // Update metrics
        function updateMetrics() {
            // If metrics panel is hidden, don't update
            if (document.getElementById('metrics-panel').classList.contains('hidden')) {
                return;
            }
            
            // Calculate and display the metrics based on completed stages and components
            const currentStageData = stages[state.currentStage - 1];
            const phase = currentStageData.phase || 1;
            
            // Get metrics either from current stage or last completed stage
            let metrics;
            if (state.completedComponents.length > 0) {
                // Find the highest stage completed in the current phase
                const highestStageCompleted = Math.max(...stages
                    .filter(stage => (stage.phase || 1) === phase && 
                                    stage.requiredComponents.every(comp => 
                                        state.completedComponents.some(c => c.type === comp)))
                    .map(stage => stage.id) || [0]);
                
                if (highestStageCompleted > 0) {
                    // Get metrics from the highest completed stage in this phase
                    const highestStageData = stages.find(stage => 
                        stage.id === highestStageCompleted && (stage.phase || 1) === phase);
                    metrics = highestStageData ? highestStageData.metrics || {} : {};
                } else {
                    // No stages completed in this phase yet
                    metrics = {};
                }
            } else {
                // No components completed yet
                metrics = {};
            }
            
            // Phase 2 - Enhance reliability, availability and performance over Phase 1
            // Each stage in Phase 2 improves metrics incrementally
            if (phase === 2) {
                // Find the highest stage completed in phase 2
                const highestPhase2StageCompleted = Math.max(...stages
                    .filter(stage => stage.phase === 2 && 
                                    stage.requiredComponents.every(comp => 
                                        state.completedComponents.some(c => c.type === comp)))
                    .map(stage => stage.id) || [0]);
                
                // Apply metric improvements based on components in Phase 2
                if (state.completedComponents.some(c => c.type === "cloudfront")) {
                    // CloudFront improves availability and latency
                    metrics.availability = Math.max(metrics.availability || 0, 99);
                    metrics.latency = Math.min(metrics.latency || 800, 50);
                }
                
                if (state.completedComponents.some(c => c.type === "cloudwatch")) {
                    // CloudWatch improves reliability through monitoring
                    metrics.reliability = Math.max(metrics.reliability || 0, 99);
                }
                
                if (state.completedComponents.some(c => c.type === "sqs")) {
                    // SQS improves reliability through asynchronous processing
                    metrics.reliability = Math.max(metrics.reliability || 0, 99.5);
                }
                
                if (state.completedComponents.some(c => c.type === "redis")) {
                    // Redis dramatically improves latency
                    metrics.latency = Math.min(metrics.latency || 800, 25);
                }
                
                // Each completed stage in Phase 2 gives additional incremental improvements
                if (highestPhase2StageCompleted >= 1) metrics.reliability = Math.max(metrics.reliability || 0, 97);
                if (highestPhase2StageCompleted >= 2) metrics.reliability = Math.max(metrics.reliability || 0, 99);
                if (highestPhase2StageCompleted >= 3) metrics.reliability = Math.max(metrics.reliability || 0, 99.5);
                if (highestPhase2StageCompleted >= 4) metrics.reliability = Math.max(metrics.reliability || 0, 99.9);
                if (highestPhase2StageCompleted >= 5) metrics.reliability = Math.max(metrics.reliability || 0, 99.95);
                
                if (highestPhase2StageCompleted >= 1) metrics.availability = Math.max(metrics.availability || 0, 99);
                if (highestPhase2StageCompleted >= 2) metrics.availability = Math.max(metrics.availability || 0, 99.5);
                if (highestPhase2StageCompleted >= 3) metrics.availability = Math.max(metrics.availability || 0, 99.8);
                if (highestPhase2StageCompleted >= 4) metrics.availability = Math.max(metrics.availability || 0, 99.9);
                if (highestPhase2StageCompleted >= 5) metrics.availability = Math.max(metrics.availability || 0, 99.95);
                
                if (highestPhase2StageCompleted >= 1) metrics.latency = Math.min(metrics.latency || 800, 50);
                if (highestPhase2StageCompleted >= 2) metrics.latency = Math.min(metrics.latency || 800, 45);
                if (highestPhase2StageCompleted >= 3) metrics.latency = Math.min(metrics.latency || 800, 40);
                if (highestPhase2StageCompleted >= 4) metrics.latency = Math.min(metrics.latency || 800, 35);
                if (highestPhase2StageCompleted >= 5) metrics.latency = Math.min(metrics.latency || 800, 25);
            }
            
            // Calculate enhanced metrics based on stage progression and components
            const enhancedMetrics = {
                // Use stage defaults or calculated values
                reliability: metrics.reliability || 0,
                availability: metrics.availability || 0,
                latency: metrics.latency || 800,
                mttr: metrics.mttr || 60,
                mttd: metrics.mttd || 30,
                
                // Calculate new metrics based on current stage and components
                users: calculateUsers(),
                satisfaction: calculateSatisfaction(),
                scalability: calculateScalability(),
                performance: calculatePerformance(), 
                security: calculateSecurity(),
                cost: calculateCost()
            };
            
            // Update reliability
            document.getElementById('metric-reliability').textContent = `${enhancedMetrics.reliability}%`;
            document.getElementById('bar-reliability').style.width = `${enhancedMetrics.reliability}%`;
            
            // Update availability
            document.getElementById('metric-availability').textContent = `${enhancedMetrics.availability}%`;
            document.getElementById('bar-availability').style.width = `${enhancedMetrics.availability}%`;
            
            // Update latency
            document.getElementById('metric-latency').textContent = `${enhancedMetrics.latency}ms`;
            document.getElementById('bar-latency').style.width = `${100 - ((enhancedMetrics.latency / 800) * 100)}%`;
            
            // Update users
            document.getElementById('metric-users').textContent = enhancedMetrics.users.value;
            document.getElementById('bar-users').style.width = `${enhancedMetrics.users.percentage}%`;
            
            // Update user satisfaction
            document.getElementById('metric-satisfaction').textContent = `${enhancedMetrics.satisfaction.value}%`;
            document.getElementById('bar-satisfaction').style.width = `${enhancedMetrics.satisfaction.percentage}%`;
            
            // Update scalability
            document.getElementById('metric-scalability').textContent = enhancedMetrics.scalability.value;
            document.getElementById('bar-scalability').style.width = `${enhancedMetrics.scalability.percentage}%`;
            
            // Update performance (transactions per second)
            document.getElementById('metric-performance').textContent = enhancedMetrics.performance.value;
            document.getElementById('bar-performance').style.width = `${enhancedMetrics.performance.percentage}%`;
            
            // Update security
            document.getElementById('metric-security').textContent = enhancedMetrics.security.value;
            document.getElementById('bar-security').style.width = `${enhancedMetrics.security.percentage}%`;
            
            // Update cost
            document.getElementById('metric-cost').textContent = enhancedMetrics.cost.value;
            document.getElementById('bar-cost').style.width = `${enhancedMetrics.cost.percentage}%`;
        }
        
        // Calculate users metric based on current components and configuration
        function calculateUsers() {
            const components = state.appliedComponents;
            let baseUsers = state.currentStage * 500; // Base users per stage
            let usersMultiplier = 1;
            
            // Adjust users based on components
            if (components.some(c => c.type === "api-gateway")) {
                const apiGw = components.find(c => c.type === "api-gateway");
                if (apiGw.config["endpoint-type"] === "Edge Optimized") baseUsers *= 1.5;
                if (apiGw.config["cache-enabled"] !== "Disabled") baseUsers *= 1.3;
                
                // Check rate limit
                if (apiGw.config["rate-limit"] === "5000") usersMultiplier *= 1.3;
                else if (apiGw.config["rate-limit"] === "10000") usersMultiplier *= 1.5;
            }
            
            if (components.some(c => c.type === "lambda")) {
                const lambda = components.find(c => c.type === "lambda");
                if (parseInt(lambda.config.memory) >= 1024) usersMultiplier *= 1.2;
                
                // Check concurrency
                if (lambda.config.concurrency === "Provisioned") usersMultiplier *= 1.5;
                else if (lambda.config.concurrency && lambda.config.concurrency !== "Unreserved") {
                    usersMultiplier *= 1.2;
                }
            }
            
            if (components.some(c => c.type === "dynamodb")) {
                const dynamo = components.find(c => c.type === "dynamodb");
                if (dynamo.config["read-capacity"] === "Auto" && dynamo.config["write-capacity"] === "Auto") {
                    usersMultiplier *= 1.4;
                }
            }
            
            // Phase 2 components increase users dramatically
            if (components.some(c => c.type === "cloudfront")) {
                usersMultiplier *= 2.0; // Global reach
            }
            
            if (components.some(c => c.type === "redis")) {
                usersMultiplier *= 1.5; // Caching improves capacity
            }
            
            if (components.some(c => c.type === "sqs")) {
                usersMultiplier *= 1.3; // Async processing reduces bottlenecks
            }
            
            // Calculate final value
            const userCount = Math.floor(baseUsers * usersMultiplier);
            
            // Return value and percentage for progress bar (max 20,000 users = 100%)
            return {
                value: userCount.toLocaleString(),
                percentage: Math.min(100, (userCount / 20000) * 100)
            };
        }
        
        // Calculate user satisfaction based on other metrics
        function calculateSatisfaction() {
            const components = state.appliedComponents;
            const metrics = stages[state.currentStage - 1].metrics || {};
            
            // Start with base satisfaction
            let satisfaction = Math.min(100, (metrics.reliability + metrics.availability) / 2);
            
            // Adjust based on latency (lower latency = higher satisfaction)
            if (metrics.latency <= 100) satisfaction += 10;
            else if (metrics.latency <= 200) satisfaction += 5;
            else if (metrics.latency >= 500) satisfaction -= 10;
            
            // Adjust based on components
            if (components.some(c => c.type === "cognito") && 
                components.find(c => c.type === "cognito").config.mfa === "REQUIRED") {
                satisfaction += 3;
            }
            
            // Phase 2 components improve satisfaction
            if (components.some(c => c.type === "cloudfront")) {
                satisfaction += 5; // Fast content delivery
            }
            
            if (components.some(c => c.type === "redis")) {
                satisfaction += 3; // Faster response times
            }
            
            if (components.some(c => c.type === "sns")) {
                satisfaction += 5; // Better user engagement through notifications
            }
            
            // If all components are complete, ensure satisfaction is appropriate for the phase
            if (state.allComponentsComplete) {
                // For Phase 1, minimum 80%
                satisfaction = Math.max(satisfaction, 80);
                
                // For Phase 2 components, push even higher
                if (components.some(c => c.type === "cloudfront") && 
                    components.some(c => c.type === "redis")) {
                    satisfaction = Math.max(satisfaction, 90);
                }
            }
            
            // Clamp to valid range
            satisfaction = Math.max(0, Math.min(100, satisfaction));
            
            return {
                value: Math.round(satisfaction),
                percentage: satisfaction
            };
        }
        
        // Calculate scalability rating
        function calculateScalability() {
            const components = state.appliedComponents;
            
            // Start with a low scalability
            let scalabilityScore = 10;
            
            // Check for key scalability components
            if (components.some(c => c.type === "lambda")) {
                const lambda = components.find(c => c.type === "lambda");
                if (lambda.config.concurrency === "Provisioned") scalabilityScore += 30;
                else if (lambda.config.concurrency === "2000 Reserved") scalabilityScore += 25;
                else if (lambda.config.concurrency === "1000 Reserved") scalabilityScore += 20;
                else if (lambda.config.concurrency !== "Unreserved") scalabilityScore += 15;
            }
            
            if (components.some(c => c.type === "dynamodb")) {
                const dynamo = components.find(c => c.type === "dynamodb");
                if (dynamo.config["read-capacity"] === "Auto" && 
                    dynamo.config["write-capacity"] === "Auto") {
                    scalabilityScore += 25;
                } else {
                    scalabilityScore += 10;
                }
            }
            
            if (components.some(c => c.type === "api-gateway")) {
                const api = components.find(c => c.type === "api-gateway");
                if (api.config["rate-limit"] === "10000") scalabilityScore += 20;
                else if (api.config["rate-limit"] === "5000") scalabilityScore += 15;
                else scalabilityScore += 10;
            }
            
            // Phase 2 components improve scalability dramatically
            if (components.some(c => c.type === "cloudfront")) {
                scalabilityScore += 15; // Global edge distribution
            }
            
            if (components.some(c => c.type === "redis")) {
                const redis = components.find(c => c.type === "redis");
                if (redis.config["cluster-mode"] === "Enabled") {
                    scalabilityScore += 15; // Cluster mode for horizontal scaling
                } else {
                    scalabilityScore += 10; // Regular caching
                }
            }
            
            if (components.some(c => c.type === "sqs")) {
                scalabilityScore += 20; // Decoupling for scalability
            }
            
            // Determine rating text based on score
            let rating = "Low";
            if (scalabilityScore >= 90) rating = "Excellent";
            else if (scalabilityScore >= 75) rating = "High";
            else if (scalabilityScore >= 60) rating = "Good";
            else if (scalabilityScore >= 40) rating = "Moderate";
            else if (scalabilityScore >= 20) rating = "Fair";
            
            return {
                value: rating,
                percentage: scalabilityScore
            };
        }
        
        // Calculate performance (transactions per second)
        function calculatePerformance() {
            const components = state.appliedComponents;
            const stage = state.currentStage - 1;
            const phase = stages[stage].phase || 1;
            
            // Base performance increases with each stage
            let baseTPS = stage * 100;
            
            // Phase 2 starts with higher base
            if (phase === 2) {
                baseTPS = 1000 + (stage * 300);
            }
            
            let multiplier = 1;
            
            // Adjust based on components
            if (components.some(c => c.type === "lambda")) {
                const lambda = components.find(c => c.type === "lambda");
                if (parseInt(lambda.config.memory) >= 1024) multiplier *= 1.5;
                else if (parseInt(lambda.config.memory) >= 512) multiplier *= 1.2;
            }
            
            if (components.some(c => c.type === "api-gateway")) {
                const api = components.find(c => c.type === "api-gateway");
                if (api.config["cache-enabled"] !== "Disabled") multiplier *= 1.4;
            }
            
            if (components.some(c => c.type === "dynamodb")) {
                const dynamo = components.find(c => c.type === "dynamodb");
                if (dynamo.config["read-capacity"] === "Auto") multiplier *= 1.2;
            }
            
            // Phase 2 performance boosters
            if (components.some(c => c.type === "redis")) {
                multiplier *= 2.0; // Caching dramatically improves throughput
            }
            
            if (components.some(c => c.type === "sqs")) {
                multiplier *= 1.5; // Async processing increases throughput
            }
            
            if (components.some(c => c.type === "cloudfront")) {
                multiplier *= 1.3; // Edge caching improves performance
            }
            
            // Calculate final TPS
            const tps = Math.floor(baseTPS * multiplier);
            
            return {
                value: tps.toLocaleString(),
                percentage: Math.min(100, (tps / 5000) * 100) // 5000 TPS = 100% (increased for Phase 2)
            };
        }
        
        // Calculate security rating
        function calculateSecurity() {
            const components = state.appliedComponents;
            
            // Start with a base security score
            let securityScore = 10;
            
            // Add points for each security component
            if (components.some(c => c.type === "cognito")) {
                const cognito = components.find(c => c.type === "cognito");
                if (cognito.config.mfa === "REQUIRED") securityScore += 25;
                else if (cognito.config.mfa === "OPTIONAL") securityScore += 15;
                else securityScore += 10;
                
                // Token expiry
                if (cognito.config["token-expiry"] === "1 hour") securityScore += 15;
                else if (cognito.config["token-expiry"] === "8 hours") securityScore += 10;
                else securityScore += 5;
            }
            
            if (components.some(c => c.type === "api-gateway")) {
                const api = components.find(c => c.type === "api-gateway");
                if (api.config["auth-type"] === "Cognito" || api.config["auth-type"] === "Lambda Authorizer") securityScore += 20;
                else if (api.config["auth-type"] !== "None") securityScore += 15;
            }
            
            if (components.some(c => c.type === "dynamodb")) {
                const dynamo = components.find(c => c.type === "dynamodb");
                if (dynamo.config.encryption === "KMS Managed" || 
                    dynamo.config.encryption === "Customer Managed") {
                    securityScore += 15;
                }
            }
            
            if (components.some(c => c.type === "s3")) {
                const s3 = components.find(c => c.type === "s3");
                if (s3.config.access === "Private") securityScore += 10;
            }
            
            // Phase 2 security enhancements
            if (components.some(c => c.type === "cloudfront")) {
                const cloudfront = components.find(c => c.type === "cloudfront");
                if (cloudfront.config.security === "HTTPS + WAF + Field-Level Encryption") {
                    securityScore += 20;
                } else if (cloudfront.config.security === "HTTPS + WAF") {
                    securityScore += 15;
                } else if (cloudfront.config.security === "HTTPS Only") {
                    securityScore += 10;
                }
            }
            
            if (components.some(c => c.type === "cloudwatch")) {
                securityScore += 10; // Monitoring improves security posture
            }
            
            if (components.some(c => c.type === "redis")) {
                const redis = components.find(c => c.type === "redis");
                if (redis.config.encryption === "Both") {
                    securityScore += 15;
                } else if (redis.config.encryption === "At-Rest" || redis.config.encryption === "In-Transit") {
                    securityScore += 10;
                }
            }
            
            // Determine rating text based on score
            let rating = "Low";
            if (securityScore >= 90) rating = "Excellent";
            else if (securityScore >= 80) rating = "High";
            else if (securityScore >= 60) rating = "Good";
            else if (securityScore >= 40) rating = "Medium";
            else if (securityScore >= 25) rating = "Basic";
            
            return {
                value: rating,
                percentage: securityScore
            };
        }
        
        // Calculate cost
        function calculateCost() {
            const components = state.appliedComponents;
            const phase = stages[state.currentStage - 1].phase || 1;
            
            // Base cost per day
            let costPerDay = 5 + (state.currentStage * 2);
            
            // Phase 2 has higher base costs
            if (phase === 2) {
                costPerDay = 20 + (state.currentStage * 5);
            }
            
            // Add cost for each component
            if (components.some(c => c.type === "lambda")) {
                const lambda = components.find(c => c.type === "lambda");
                costPerDay += parseInt(lambda.config.memory) / 128; // Memory affects cost
                
                if (lambda.config.concurrency === "Provisioned") costPerDay += 15;
                else if (lambda.config.concurrency !== "Unreserved") {
                    costPerDay += parseInt(lambda.config.concurrency.split(" ")[0]) / 100;
                }
            }
            
            if (components.some(c => c.type === "api-gateway")) {
                const api = components.find(c => c.type === "api-gateway");
                costPerDay += 3;
                
                if (api.config["cache-enabled"] !== "Disabled") {
                    const cacheSize = parseFloat(api.config["cache-enabled"].split("/")[0].split("GB")[0]);
                    costPerDay += cacheSize * 3;
                }
                
                // Rate limit affects cost
                if (api.config["rate-limit"] === "10000") costPerDay += 8;
                else if (api.config["rate-limit"] === "5000") costPerDay += 5;
                else if (api.config["rate-limit"] === "2000") costPerDay += 3;
                else costPerDay += 2;
            }
            
            if (components.some(c => c.type === "dynamodb")) {
                const dynamo = components.find(c => c.type === "dynamodb");
                
                // Auto scaling is more cost-effective at scale
                if (dynamo.config["read-capacity"] === "Auto") {
                    costPerDay += 2;
                } else {
                    costPerDay += parseInt(dynamo.config["read-capacity"]) * 0.5;
                }
                
                if (dynamo.config["write-capacity"] === "Auto") {
                    costPerDay += 2;
                } else {
                    costPerDay += parseInt(dynamo.config["write-capacity"]) * 0.8;
                }
                
                // Secondary indexes add cost
                if (dynamo.config["secondary-indexes"] && 
                    dynamo.config["secondary-indexes"] !== "None") {
                    costPerDay += 3;
                }
            }
            
            // Basic services
            if (components.some(c => c.type === "s3")) costPerDay += 1;
            if (components.some(c => c.type === "cognito")) costPerDay += 2;
            
            // Phase 2 components add costs
            if (components.some(c => c.type === "cloudfront")) {
                const cloudfront = components.find(c => c.type === "cloudfront");
                if (cloudfront.config["price-class"] === "All Edge Locations") {
                    costPerDay += 12;
                } else if (cloudfront.config["price-class"] === "North America & Europe") {
                    costPerDay += 8;
                } else {
                    costPerDay += 5;
                }
            }
            
            if (components.some(c => c.type === "cloudwatch")) {
                const cloudwatch = components.find(c => c.type === "cloudwatch");
                if (cloudwatch.config.metrics === "Detailed") {
                    costPerDay += 5;
                } else if (cloudwatch.config.metrics === "Custom") {
                    costPerDay += 8;
                } else {
                    costPerDay += 2;
                }
                
                // Log retention costs
                if (cloudwatch.config["log-retention"] === "1 year") {
                    costPerDay += 6;
                } else if (cloudwatch.config["log-retention"] === "6 months") {
                    costPerDay += 4;
                } else if (cloudwatch.config["log-retention"] === "1 month") {
                    costPerDay += 2;
                } else {
                    costPerDay += 1;
                }
                
                // Dashboard costs
                if (cloudwatch.config.dashboard === "Comprehensive") {
                    costPerDay += 3;
                } else if (cloudwatch.config.dashboard === "Basic") {
                    costPerDay += 1;
                }
            }
            
            if (components.some(c => c.type === "redis")) {
                const redis = components.find(c => c.type === "redis");
                
                // Instance type costs
                if (redis.config["instance-type"] === "cache.r5.xlarge") {
                    costPerDay += 15;
                } else if (redis.config["instance-type"] === "cache.r5.large") {
                    costPerDay += 10;
                } else if (redis.config["instance-type"] === "cache.m5.large") {
                    costPerDay += 8;
                } else if (redis.config["instance-type"] === "cache.t3.small") {
                    costPerDay += 5;
                } else {
                    costPerDay += 2;
                }
                
                // Node costs
                costPerDay += parseInt(redis.config.nodes) * 2;
                
                // Cluster mode costs extra
                if (redis.config["cluster-mode"] === "Enabled") {
                    costPerDay += 5;
                }
            }
            
            if (components.some(c => c.type === "sqs")) {
                costPerDay += 3; // SQS base cost
                
                const sqs = components.find(c => c.type === "sqs");
                if (sqs.config["queue-type"] === "FIFO") {
                    costPerDay += 2; // FIFO costs more
                }
                
                // DLQ costs
                if (sqs.config.dlq !== "None") {
                    costPerDay += 1;
                }
            }
            
            if (components.some(c => c.type === "sns")) {
                const sns = components.find(c => c.type === "sns");
                
                // Different subscriber types have different costs
                if (sns.config.subscribers === "Multiple Types") {
                    costPerDay += 5;
                } else if (sns.config.subscribers === "SMS Only") {
                    costPerDay += 8; // SMS is expensive
                } else {
                    costPerDay += 2;
                }
                
                // Message filtering adds cost
                if (sns.config["message-filtering"] === "Advanced") {
                    costPerDay += 3;
                } else if (sns.config["message-filtering"] === "Basic") {
                    costPerDay += 1;
                }
            }
            
            // Format cost string and percentage (100% = $200/day for Phase 2)
            const maxCost = phase === 2 ? 200 : 100;
            return {
                value: `$${costPerDay.toFixed(0)}/day`,
                percentage: Math.min(100, (costPerDay / maxCost) * 100)
            };
        }

        // Show instructions modal
        function showInstructionsModal() {
            const currentStageData = stages[state.currentStage - 1];
            const modal = document.getElementById('instructions-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalStageNumber = document.getElementById('modal-stage-number');
            const modalContent = document.getElementById('modal-content');
            
            modalTitle.textContent = currentStageData.name;
            modalStageNumber.textContent = currentStageData.id;
            modalContent.innerHTML = currentStageData.detailedInstructions;
            
            // Reset scroll position to top before showing
            // Target the actual scrollable content container
            document.querySelector('#instructions-modal .modal-content').scrollTop = 0;
            
            modal.classList.add('show');
        }

        // Hide instructions modal
        function hideInstructionsModal() {
            const modal = document.getElementById('instructions-modal');
            modal.classList.remove('show');
        }

        // SVG architecture visualization with layers
        function renderArchitecture() {
            const container = document.getElementById('architecture-diagram');
            container.innerHTML = '';
            
            // Create SVG element - larger viewbox to accommodate more layers
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '100%');
            svg.setAttribute('viewBox', '0 0 360 700'); // Shorter viewBox since storage layer is moved
            container.appendChild(svg);
            
            // Create background grid
            renderGrid(svg);
            
            // Draw architecture layers
            renderLayers(svg);
            
            // Add connection lines
            renderConnections(svg);
            
            // Add components
            renderComponents(svg);
        }

        // Render grid background
        function renderGrid(svg) {
            const grid = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            grid.classList.add('grid');
            
            // Vertical grid lines
            for (let i = 0; i < 400; i += 30) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', i);
                line.setAttribute('y1', 0);
                line.setAttribute('x2', i);
                line.setAttribute('y2', 700); // Adjusted height
                line.setAttribute('stroke', '#eee');
                line.setAttribute('stroke-width', '1');
                grid.appendChild(line);
            }
            
            // Horizontal grid lines
            for (let i = 0; i < 700; i += 30) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', 0);
                line.setAttribute('y1', i);
                line.setAttribute('x2', 400);
                line.setAttribute('y2', i);
                line.setAttribute('stroke', '#eee');
                line.setAttribute('stroke-width', '1');
                grid.appendChild(line);
            }
            
            svg.appendChild(grid);
        }

        // Render architecture layers
        function renderLayers(svg) {
            const layerGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            layerGroup.classList.add('layers');
            
            // For each component in appliedComponents, get its layer and add it to our list of layers to draw
            // This ensures all applied components' layers are drawn immediately, even if not yet completed
            const layersToRender = new Set();
            
            // First get the layers from completed components
            state.completedComponents.forEach(component => {
                const componentType = component.type;
                const layer = componentsData[componentType].layer;
                layersToRender.add(layer);
            });
            
            // Also include layers from components that are applied but not yet completed
            state.appliedComponents.forEach(component => {
                const componentType = component.type;
                const layer = componentsData[componentType].layer;
                layersToRender.add(layer);
            });
            
            // Draw all layers that have components
            Object.keys(architectureLayers).forEach(layerKey => {
                const layer = architectureLayers[layerKey];
                
                // Skip layers with no components
                if (!layersToRender.has(layerKey)) return;
                
                // Create layer rectangle
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', layer.x);
                rect.setAttribute('y', layer.y);
                rect.setAttribute('width', layer.width);
                rect.setAttribute('height', layer.height);
                rect.setAttribute('fill', layer.color);
                rect.setAttribute('stroke', layer.color);
                rect.setAttribute('class', 'arch-layer');
                rect.setAttribute('rx', '5');
                layerGroup.appendChild(rect);
                
                // Add layer label - positioned at the top left with offset
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', layer.x + 10);
                text.setAttribute('y', layer.y + 20); // Position higher to avoid components
                text.setAttribute('class', 'arch-layer-label');
                text.setAttribute('fill', layer.color);
                text.textContent = layer.name;
                layerGroup.appendChild(text);
            });
            
            svg.appendChild(layerGroup);
        }

        // Render connection lines between components
        function renderConnections(svg) {
            const components = state.completedComponents;
            const connectionGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            
            // Define valid connections - connections will be drawn both ways
            const validConnections = {
                "api-gateway": ["lambda", "cognito", "cloudfront"],
                "lambda": ["dynamodb", "s3", "cognito", "sqs", "sns", "redis"],
                "dynamodb": ["lambda"],
                "redis": ["lambda"],
                "s3": ["lambda", "cloudfront"],
                "cloudfront": ["s3", "api-gateway"],
                "cognito": ["api-gateway", "lambda"],
                "cloudwatch": ["lambda", "api-gateway", "dynamodb", "s3", "sqs", "sns"],
                "sqs": ["lambda"],
                "sns": ["lambda"]
            };
            
            // Ensure components are connected
            if (components.length > 1) {
                // First add direct connections
                for (let i = 0; i < components.length; i++) {
                    for (let j = 0; j < components.length; j++) {
                        if (i === j) continue;
                        
                        const comp1 = components[i].type;
                        const comp2 = components[j].type;
                        
                        // Get layer for each component
                        const layer1 = componentsData[comp1].layer;
                        const layer2 = componentsData[comp2].layer;
                        
                        // Check if connection exists
                        if (validConnections[comp1]?.includes(comp2)) {
                            const position1 = componentPositions[layer1][comp1];
                            const position2 = componentPositions[layer2][comp2];
                            
                            if (position1 && position2) {
                                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                                line.setAttribute('x1', position1.x + 20);  // Smaller component center
                                line.setAttribute('y1', position1.y + 20);  // Smaller component center
                                line.setAttribute('x2', position2.x + 20);  // Smaller component center
                                line.setAttribute('y2', position2.y + 20);  // Smaller component center
                                line.setAttribute('stroke', '#000000');  // Changed to black connections
                                line.setAttribute('stroke-width', '1');   // Thinner lines
                                line.setAttribute('stroke-dasharray', '3,3'); // Shorter dashes for cleaner look
                                connectionGroup.appendChild(line);
                            }
                        }
                    }
                }
            }
            
            svg.appendChild(connectionGroup);
        }

        // Render components on the diagram - show both completed and applied components
        function renderComponents(svg) {
            const componentGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            componentGroup.classList.add('components');
            
            // Get all component types to render
            const componentsToRender = new Set();
            
            // Add completed components
            state.completedComponents.forEach(component => {
                componentsToRender.add(component.type);
            });
            
            // Also add applied but not yet completed components
            state.appliedComponents.forEach(component => {
                componentsToRender.add(component.type);
            });
            
            // Render all components
            Array.from(componentsToRender).forEach(compType => {
                const layer = componentsData[compType].layer;
                const position = componentPositions[layer][compType];
                
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('transform', `translate(${position.x},${position.y})`);
                
                // Component background - smaller size (40x40)
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '40');
                rect.setAttribute('height', '40');
                rect.setAttribute('rx', '4');
                rect.setAttribute('fill', '#FFF');
                rect.setAttribute('stroke', '#000');  // Changed to black border
                rect.setAttribute('stroke-width', '1');  // Thinner border
                g.appendChild(rect);
                
                // Component icon (using the global componentsData) - smaller size
                const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
                foreignObject.setAttribute('width', '40');
                foreignObject.setAttribute('height', '25');
                foreignObject.setAttribute('x', '0');
                foreignObject.setAttribute('y', '3');
                
                const div = document.createElement('div');
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.color = '#5D5CDE';
                div.className = 'component-icon';
                div.innerHTML = componentsData[compType].icon;
                
                foreignObject.appendChild(div);
                g.appendChild(foreignObject);
                
                // Component label
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', '20');
                text.setAttribute('y', '35');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#232F3E');
                text.setAttribute('font-size', '7');
                text.textContent = componentsData[compType].name;
                g.appendChild(text);
                
                componentGroup.appendChild(g);
            });
            
            svg.appendChild(componentGroup);
        }

        // Initialize the application
        init();
    </script>
</body>
</html>

